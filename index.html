<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>صديقي الذكي — النسخة النهائية</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    html,body{overscroll-behavior-y:contain;height:100%;margin:0;padding:0}
    body{font-family:'Tajawal',sans-serif;-webkit-tap-highlight-color:transparent}
    /* خلفية تعبّر عن الطفولة الإماراتية (ثوب/رمال/طائرات ورقية كرمزية لعب طفولي خليجي) */
    #app-wrapper{
      background-image:
        linear-gradient(rgba(241,245,249,.92),rgba(241,245,249,.92)),
        url('https://images.unsplash.com/photo-1542810634-71277d95dcbb?q=80&w=1600&auto=format&fit=crop'); 
      background-size: cover; background-position: center;
    }
    #app-container{height:100%;height:100dvh}
    .screen,.modal{display:none}.screen.active,.modal.active{display:flex}
    .bg-screen{background-color:rgba(248,250,252,.95);backdrop-filter:blur(2px)}
    .fade-in{animation:fadeIn .5s ease-in-out}@keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .scale-up{animation:scaleUp .3s cubic-bezier(.175,.885,.32,1.275)}
    @keyframes scaleUp{from{opacity:0;transform:scale(.94)}to{opacity:1;transform:scale(1)}}
    .chat-bubble{animation:popIn .3s cubic-bezier(.175,.885,.32,1.275)}
    @keyframes popIn{from{opacity:0;transform:scale(.5)}to{opacity:1;transform:scale(1)}}
    .typing-indicator span{animation:bounce 1.4s infinite ease-in-out both}
    .typing-indicator span:nth-child(1){animation-delay:-.32s}
    .typing-indicator span:nth-child(2){animation-delay:-.16s}
    @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
    #chat-messages::-webkit-scrollbar{width:6px}
    #chat-messages::-webkit-scrollbar-track{background:#f1f5f9}
    #chat-messages::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:10px}
    .gender-btn.selected,.age-btn.selected{border-color:#0ea5e9;background-color:#f0f9ff;color:#0284c7}
    #continue-profile-btn:disabled,#analyze-btn:disabled{background-color:#94a3b8;cursor:not-allowed}
    @keyframes shake{10%,90%{transform:translate3d(-1px,0,0)}20%,80%{transform:translate3d(2px,0,0)}30%,50%,70%{transform:translate3d(-4px,0,0)}40%,60%{transform:translate3d(4px,0,0)}}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .6rem;border-radius:9999px;font-size:.75rem}
    .brand-gradient{background:linear-gradient(135deg,#06b6d4 0%,#0ea5e9 100%);-webkit-background-clip:text;background-clip:text;color:transparent}
  </style>
</head>
<body class="bg-slate-200 text-slate-800 antialiased">
  <div id="app-wrapper">
    <div id="app-container" class="w-full max-w-md md:max-w-lg mx-auto bg-transparent shadow-lg flex flex-col overflow-hidden relative">
      <div id="main-content-area" class="flex-grow relative flex flex-col"></div>

      <!-- حقوق الأداة (تصميم جمالي) -->
      <footer class="w-full mx-auto shrink-0 bg-white/70 backdrop-blur border-t border-slate-200">
        <div class="px-3 py-2 text-[11px] sm:text-xs flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="badge bg-cyan-100 text-cyan-700 font-semibold"><i data-lucide="shield-check" class="w-3.5 h-3.5"></i> أمان الطفل أولاً</span>
            <span class="badge bg-emerald-100 text-emerald-700 font-semibold"><i data-lucide="sprout" class="w-3.5 h-3.5"></i> توجيه تربوي إيجابي</span>
          </div>
          <div class="font-bold brand-gradient">© صديقي الذكي — بإشراف أولياء الأمور</div>
        </div>
      </footer>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const mainContentArea = document.getElementById('main-content-area');
    const appWrapper = document.getElementById('app-wrapper');

    /* ============================ بناء الشاشات ============================ */
    const screenHTML = `
      <!-- اختيار العمر -->
      <div id="age-selection-screen" class="screen flex-col justify-center items-center p-8 text-center h-full bg-screen">
        <i data-lucide="users-2" class="w-16 h-16 text-sky-500 mx-auto mb-6"></i>
        <h2 class="text-2xl font-bold mb-2">مرحباً بوليّ الأمر</h2>
        <p class="text-slate-600 mb-8">لتخصيص التجربة، يرجى تحديد الفئة العمرية للطفل.</p>
        <div class="w-full space-y-3">
          <button data-age="3-7"  class="age-btn w-full text-lg bg-white/80 border-2 border-slate-200 hover:border-sky-500 hover:bg-sky-50 transition-all p-4 rounded-xl font-bold">3 - 7 سنوات <span class="block text-sm font-normal text-slate-500">الطفولة المبكرة</span></button>
          <button data-age="8-12" class="age-btn w-full text-lg bg-white/80 border-2 border-slate-200 hover:border-sky-500 hover:bg-sky-50 transition-all p-4 rounded-xl font-bold">8 - 12 سنة <span class="block text-sm font-normal text-slate-500">مرحلة الطفولة</span></button>
          <button data-age="13-18" class="age-btn w-full text-lg bg-white/80 border-2 border-slate-200 hover:border-sky-500 hover:bg-sky-50 transition-all p-4 rounded-xl font-bold">13 - 18 سنة <span class="block text-sm font-normal text-slate-500">مرحلة المراهقة</span></button>
        </div>
      </div>

      <!-- إعداد الملف -->
      <div id="profile-setup-screen" class="screen flex-col justify-center p-8 h-full bg-screen">
        <i data-lucide="user-round-check" class="w-16 h-16 text-sky-500 mx-auto mb-6"></i>
        <h2 class="text-2xl font-bold text-center mb-2">ملف البطل الشخصي</h2>
        <p class="text-slate-600 text-center mb-8">هذه المعلومات تجعل التجربة شخصية ومميزة.</p>
        <div class="w-full space-y-6">
          <div>
            <label for="child-name-input" class="font-bold mb-2 block">اسم الطفل/الطفلة</label>
            <input id="child-name-input" type="text" placeholder="مثال: خالد أو علياء" class="w-full bg-white/80 border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-sky-400 transition">
          </div>
          <div>
            <p class="font-bold mb-2">الجنس</p>
            <div class="grid grid-cols-2 gap-4">
              <button data-gender="ذكر"  class="gender-btn w-full flex flex-col items-center gap-2 text-lg bg-white/80 border-2 border-slate-200 p-4 rounded-xl font-bold"><i data-lucide="user-round" class="w-8 h-8"></i> ذكر</button>
              <button data-gender="أنثى" class="gender-btn w-full flex flex-col items-center gap-2 text-lg bg-white/80 border-2 border-slate-200 p-4 rounded-xl font-bold"><i data-lucide="user-round" class="w-8 h-8"></i> أنثى</button>
            </div>
          </div>
        </div>
        <div class="mt-auto pt-8">
          <button id="continue-profile-btn" class="w-full bg-sky-500 text-white font-bold py-4 px-6 rounded-full text-lg shadow-lg" disabled>متابعة</button>
        </div>
      </div>

      <!-- إدخال وليّ الأمر -->
      <div id="parent-input-screen" class="screen flex-col p-8 h-full bg-screen overflow-y-auto">
        <i data-lucide="file-text" class="w-16 h-16 text-sky-500 mx-auto mb-6 shrink-0"></i>
        <h2 class="text-2xl font-bold text-center mb-2">رؤية وليّ الأمر</h2>
        <p class="text-slate-600 text-center mb-8 shrink-0">كلما كانت التفاصيل أدق، كانت الخطة أفضل. لا نطلب بيانات تعريفية.</p>
        <div class="w-full space-y-6 flex-grow">
          <div>
            <label class="font-bold mb-2 block">1) كيف تصف شخصية طفلك؟</label>
            <textarea id="child-personality" rows="3" placeholder="مثال: مبدع، هادئ، حساس، حركي..." class="w-full bg-white/80 border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-sky-400 transition"></textarea>
          </div>
          <div>
            <label class="font-bold mb-2 block">2) ما أهم التحديات الاجتماعية التي تواجهه؟</label>
            <textarea id="child-challenges" rows="4" placeholder="مثال: صعوبة تكوين صداقات، خجل من المشاركة..." class="w-full bg-white/80 border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-sky-400 transition"></textarea>
          </div>
        </div>
        <div class="mt-auto pt-8 shrink-0">
          <button id="analyze-btn" class="w-full bg-sky-500 text-white font-bold py-4 px-6 rounded-full text-lg shadow-lg hover:bg-sky-600" disabled>تحليل وإنشاء الخطة الأولية</button>
        </div>
      </div>

      <!-- مراجعة الخطة + دورة الموافقة/التعديل -->
      <div id="plan-review-screen" class="screen flex-col p-8 h-full bg-screen overflow-y-auto">
        <div id="loading-spinner" class="m-auto text-center flex flex-col items-center justify-center">
          <i data-lucide="loader-circle" class="w-16 h-16 text-sky-500 mx-auto mb-4 animate-spin"></i>
          <h3 class="text-xl font-bold">تحليل المدخلات وإنشاء الخطة الأولية...</h3>
          <p class="text-slate-500">ثوانٍ قليلة.</p>
        </div>
        <div id="plan-content" class="hidden w-full h-full flex flex-col">
          <i data-lucide="clipboard-check" class="w-16 h-16 text-green-500 mx-auto mb-6 shrink-0"></i>
          <h2 class="text-2xl font-bold text-center mb-2">الخطة المقترحة (للـمراجعة)</h2>
          <p class="text-slate-600 text-center mb-6">يرجى <b>الموافقة</b> أو <b>طلب تعديل</b>. عند طلب تعديل سنسأل عن الأسباب لإنتاج خطة أدق.</p>
          <div class="bg-white border border-slate-200 rounded-xl p-4 space-y-4 flex-grow">
            <div>
              <h4 class="font-bold flex items-center gap-2"><i data-lucide="user-round-cog" class="w-5 h-5 text-sky-600"></i>ملف الطفل (ملخص)</h4>
              <p id="ai-analysis-summary" class="text-slate-700 mt-1"></p>
            </div>
            <div>
              <h4 class="font-bold flex items-center gap-2"><i data-lucide="target" class="w-5 h-5 text-sky-600"></i>فرضية الاحتياجات</h4>
              <ul id="ai-needs-hypo" class="list-disc list-inside mt-2 space-y-1 text-slate-700"></ul>
            </div>
            <div>
              <h4 class="font-bold flex items-center gap-2"><i data-lucide="list-checks" class="w-5 h-5 text-sky-600"></i>خطوات التدريب (متدرجة)</h4>
              <ul id="ai-plan-steps" class="list-decimal list-inside mt-2 space-y-1 text-slate-700"></ul>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-6">
            <button id="approve-plan-btn" class="w-full bg-emerald-600 text-white font-bold py-3 px-6 rounded-full shadow-lg shadow-emerald-200 hover:bg-emerald-700">موافقة على الخطة</button>
            <button id="request-edit-btn" class="w-full bg-amber-500 text-white font-bold py-3 px-6 rounded-full shadow-lg shadow-amber-200 hover:bg-amber-600">طلب تعديل الخطة</button>
          </div>
        </div>
      </div>

      <!-- شاشة طلب أسباب التعديل -->
      <div id="plan-change-screen" class="screen flex-col p-8 h-full bg-screen overflow-y-auto">
        <i data-lucide="edit" class="w-16 h-16 text-sky-500 mx-auto mb-6 shrink-0"></i>
        <h2 class="text-2xl font-bold text-center mb-2">تفاصيل أسباب التعديل</h2>
        <p class="text-slate-600 text-center mb-6">اذكر الأسباب المحددة (مواقف، سلوكيات، أهداف جديدة، حساسية ثقافية/مدرسية...)</p>
        <textarea id="plan-change-reason" rows="6" class="w-full bg-white/80 border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-sky-400 transition" placeholder="مثال: الخطوة الثانية صعبة على طفلي حالياً؛ نحتاج تمهيداً أقصر ووقت لعب موجه..."></textarea>
        <div class="mt-6">
          <button id="re-analyze-btn" class="w-full bg-sky-500 text-white font-bold py-3 px-6 rounded-full text-lg shadow-lg hover:bg-sky-600">إعادة التحليل وإنتاج خطة جديدة</button>
        </div>
      </div>

      <!-- الصفحة الرئيسية للطفل -->
      <div id="home-screen" class="screen flex-col p-6 h-full bg-transparent">
        <header class="flex justify-between items-center mb-6">
          <div>
            <p id="home-greeting" class="text-slate-500"></p>
            <h2 id="home-mission-status" class="text-2xl font-bold">جاهز لمغامرة اليوم؟</h2>
          </div>
          <div class="flex items-center gap-2">
            <button id="reset-app-btn" title="إعادة ضبط" class="p-2 rounded-full bg-white/50 hover:bg-red-100 text-red-500 transition-colors"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
          </div>
        </header>
        <main class="flex-grow flex flex-col justify-center items-center text-center">
          <div class="w-44 h-44 md:w-48 md:h-48 bg-white/50 backdrop-blur-sm rounded-full flex items-center justify-center mb-6"><i data-lucide="bot" class="w-24 h-24 md:w-28 md:h-28 text-sky-600"></i></div>
          <h3 id="home-ai-name-intro" class="text-2xl font-bold mb-2"></h3>
          <p id="home-intro-text" class="text-slate-500 max-w-xs mb-6"></p>
          <button id="initiate-chat-btn" class="w-full bg-sky-500 text-white font-bold py-4 px-6 rounded-full text-lg shadow-lg flex items-center justify-center gap-2">
            <i data-lucide="message-circle"></i><span id="start-chat-btn-text"></span>
          </button>
        </main>
      </div>

      <!-- المحادثة -->
      <div id="chat-screen" class="screen flex-col h-full bg-screen">
        <header class="bg-white p-4 flex items-center gap-4 border-b border-slate-200">
          <button id="end-chat-btn" class="p-2 rounded-full hover:bg-slate-100 transition-colors"><i data-lucide="arrow-right"></i></button>
          <div class="w-10 h-10 bg-gradient-to-br from-cyan-100 to-sky-200 rounded-full flex items-center justify-center shrink-0"><i data-lucide="bot" class="w-6 h-6 text-sky-600"></i></div>
          <div class="flex-grow">
            <h3 id="chat-header-name" class="font-bold"></h3>
            <p class="text-xs text-green-500 font-medium flex items-center gap-1"><span class="w-2 h-2 bg-green-400 rounded-full"></span>متصل</p>
          </div>
          <button id="language-toggle-btn" title="تبديل اللغة" class="p-2 rounded-full hover:bg-slate-100 text-slate-600 transition-colors"><i data-lucide="languages" class="w-5 h-5"></i></button>
        </header>
        <main id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto"></main>
        <footer class="p-4 border-t border-slate-200 bg-white/85 backdrop-blur-sm">
          <div id="chat-options-container" class="mb-3 grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
          <form id="chat-form" class="flex items-center gap-2">
            <input id="chat-input" type="text" placeholder="اكتب ردك هنا..." class="w-full bg-white border-2 border-slate-200 rounded-full py-2 px-4 focus:outline-none focus:border-sky-400 transition"/>
            <button type="submit" class="bg-sky-500 text-white rounded-full p-3 hover:bg-sky-600 transition-transform transform hover:scale-110 active:scale-95 shrink-0"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
          </form>
        </footer>
      </div>
    `;
    mainContentArea.innerHTML = screenHTML;

    /* ============================ المودالات ============================ */
    const consentHTML = `
      <div id="consent-modal" class="modal active absolute inset-0 bg-black/50 z-50 justify-center items-center p-4 backdrop-blur-sm fade-in">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-xl p-6 scale-up">
          <div class="text-center">
            <i data-lucide="shield-check" class="w-16 h-16 text-sky-500 mx-auto mb-4"></i>
            <h3 class="text-xl font-bold mb-2">كيف تعمل الأداة؟ وما التزاماتنا؟</h3>
            <p class="text-slate-600 mb-4 text-sm">
              نجمع وصف وليّ الأمر، نحلّله بالذكاء الاصطناعي، ننتج <b>خطة أولية</b> تُعرض للموافقة أو التعديل.
              عند طلب التعديل نطلب <b>الأسباب</b> ثم نولّد <b>خطة جديدة</b>. بعد الموافقة يبدأ <b>اختبار أولي قصير</b> مع الطفل
              لاكتشاف الاحتياجات الحقيقية ثم ننطلق في تدريب سلوكي متدرّج.
            </p>
          </div>
          <ul class="space-y-3 text-sm text-slate-700">
            <li class="flex items-start gap-3"><i data-lucide="scale" class="w-5 h-5 text-sky-500 mt-0.5"></i><span><b>امتثال:</b> نلتزم بقوانين دولة الإمارات والمعايير الدولية لأمان الطفل (منع المحتوى غير اللائق/التحرش/الاستغلال، مسار تصعيد عند مؤشرات الخطر).</span></li>
            <li class="flex items-start gap-3"><i data-lucide="database" class="w-5 h-5 text-sky-500 mt-0.5"></i><span><b>خصوصية:</b> لا نطلب بيانات تعريفية؛ التخزين محلي في جهازك؛ تُرسل نصوص ضرورية فقط للنموذج.</span></li>
            <li class="flex items-start gap-3"><i data-lucide="stethoscope" class="w-5 h-5 text-sky-500 mt-0.5"></i><span><b>حدود:</b> توجيه تربوي سلوكي—not تشخيص طبي/نفسي. للحالات الخطرة يُنصح بالرجوع لمختص مرخّص.</span></li>
            <li class="flex items-start gap-3"><i data-lucide="child" class="w-5 h-5 text-sky-500 mt-0.5"></i><span><b>وضوح الهدف:</b> تمكين الطفل تدريجياً للخروج من المشكلة محورياً عبر تمارين قصيرة وقابلة للقياس.</span></li>
          </ul>
          <button id="accept-consent-btn" class="mt-6 w-full bg-sky-500 text-white font-bold py-3 px-6 rounded-full hover:bg-sky-600">أوافق وأفهم (وليّ الأمر)</button>
        </div>
      </div>
    `;
    appWrapper.insertAdjacentHTML('beforeend', consentHTML);

    /* ============================ الحالة والثوابت ============================ */
    const dom = {
      screens: document.querySelectorAll('.screen'),
      ageButtons: document.querySelectorAll('.age-btn'),
      genderButtons: document.querySelectorAll('.gender-btn'),
      continueProfileBtn: document.getElementById('continue-profile-btn'),
      childNameInput: document.getElementById('child-name-input'),
      personalityInput: document.getElementById('child-personality'),
      challengesInput: document.getElementById('child-challenges'),
      analyzeBtn: document.getElementById('analyze-btn'),

      loadingSpinner: document.getElementById('loading-spinner'),
      planContent: document.getElementById('plan-content'),
      aiAnalysisSummary: document.getElementById('ai-analysis-summary'),
      aiNeedsHypo: document.getElementById('ai-needs-hypo'),
      aiPlanSteps: document.getElementById('ai-plan-steps'),
      approvePlanBtn: document.getElementById('approve-plan-btn'),
      requestEditBtn: document.getElementById('request-edit-btn'),

      homeGreeting: document.getElementById('home-greeting'),
      homeAiNameIntro: document.getElementById('home-ai-name-intro'),
      startChatBtnText: document.getElementById('start-chat-btn-text'),
      homeIntroText: document.getElementById('home-intro-text'),
      homeMissionStatus: document.getElementById('home-mission-status'),
      initiateChatBtn: document.getElementById('initiate-chat-btn'),
      endChatBtn: document.getElementById('end-chat-btn'),
      languageToggleBtn: document.getElementById('language-toggle-btn'),

      chatMessages: document.getElementById('chat-messages'),
      chatOptionsContainer: document.getElementById('chat-options-container'),
      chatForm: document.getElementById('chat-form'),
      chatInput: document.getElementById('chat-input'),

      planChangeReason: document.getElementById('plan-change-reason'),
      reAnalyzeBtn: document.getElementById('re-analyze-btn'),
      resetAppBtn: document.getElementById('reset-app-btn'),

      acceptConsentBtn: document.getElementById('accept-consent-btn')
    };

    let state = {};
    const STORAGE_KEY = 'sadikiAi_v20_uae';
    const API_PROXY_URL = '/.netlify/functions/gemini';

    const UAE_COMPLIANCE = `
- التزم بقوانين دولة الإمارات والمعايير الدولية لسلامة الطفل.
- لا تُقدم تشخيصاً طبياً/نفسيّاً. وجّه لمختص مرخّص عند مؤشرات الخطر.
- تجنّب جمع بيانات تعريفية؛ لا تطلب عنوان/مدرسة/أرقام.
- عند الإساءة/التنمّر/إيذاء: أوقف التقدّم وقدّم تعليمات لإبلاغ وليّ الأمر/المدرسة.
`;

    const saveState = () => { try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch{} };
    const loadState = () => { try{ const d=localStorage.getItem(STORAGE_KEY); if(d){ state=JSON.parse(d); return true; } }catch{} return false; };
    const resetState = () => { state = { language:'ar', ageGroup:null, name:null, gender:null, aiName:null, parentDescription:null, trainingPlan:null, chatHistory:[], currentPlanStep:0, assessment:null }; };

    const getAiName = (age,gender) => {
      if(age==='3-7')  return gender==='ذكر'?'سيف':'نورة';
      if(age==='8-12') return gender==='ذكر'?'راشد':'مريم';
      if(age==='13-18')return gender==='ذكر'?'سلطان':'آمنة';
      return 'صديقك الذكي';
    };

    const showScreen = id => document.querySelectorAll('.screen').forEach(s=>s.classList.toggle('active', s.id===id));
    const hideModal = id => document.getElementById(id)?.classList.remove('active');

    /* ============================ أحداث الواجهة ============================ */
    dom.acceptConsentBtn.addEventListener('click',()=>{ hideModal('consent-modal'); showScreen('age-selection-screen'); });
    dom.ageButtons.forEach(b=>b.addEventListener('click',e=>{ state.ageGroup=e.currentTarget.dataset.age; showScreen('profile-setup-screen'); }));
    dom.genderButtons.forEach(btn=>btn.addEventListener('click',e=>{
      state.gender=e.currentTarget.dataset.gender;
      document.querySelectorAll('.gender-btn').forEach(x=>x.classList.remove('selected'));
      e.currentTarget.classList.add('selected'); validateProfileInput();
    }));
    dom.childNameInput.addEventListener('input',validateProfileInput);
    dom.continueProfileBtn.addEventListener('click',()=>{
      if(dom.continueProfileBtn.disabled) return;
      state.name = dom.childNameInput.value.trim();
      state.aiName = getAiName(state.ageGroup,state.gender);
      showScreen('parent-input-screen');
    });

    dom.personalityInput.addEventListener('input',validateParentInput);
    dom.challengesInput.addEventListener('input',validateParentInput);
    dom.analyzeBtn.addEventListener('click',()=>generatePlan(false));

    dom.approvePlanBtn.addEventListener('click',approvePlan);
    dom.requestEditBtn.addEventListener('click',()=>{ showScreen('plan-change-screen'); });

    dom.reAnalyzeBtn.addEventListener('click',()=>generatePlan(true));
    dom.resetAppBtn.addEventListener('click',()=>{ localStorage.removeItem(STORAGE_KEY); location.reload(); });

    dom.initiateChatBtn.addEventListener('click',()=>initiateChat(false));
    dom.endChatBtn.addEventListener('click',()=>{ showScreen('home-screen'); updateUi(); });
    dom.chatForm.addEventListener('submit',e=>{ e.preventDefault(); const v=dom.chatInput.value.trim(); if(v){ handleUserChoice(v); dom.chatInput.value=''; } });
    dom.languageToggleBtn.addEventListener('click',()=>{ state.language = state.language==='ar'?'en':'ar'; state.chatHistory.push({role:'user',parts:[{text:`(System instruction: switch to ${state.language})`} ]}); saveState(); updateUi(); getChatResponse(`(System instruction: switch to ${state.language} and confirm.)`); });

    function validateProfileInput(){
      const ok = dom.childNameInput.value.trim().length>1 && !!state.gender && !!state.ageGroup;
      dom.continueProfileBtn.disabled = !ok;
    }
    function validateParentInput(){
      const ok = dom.personalityInput.value.trim().length>5 && dom.challengesInput.value.trim().length>10;
      dom.analyzeBtn.disabled = !ok;
    }

    /* ============================ نصوص الذكاء الاصطناعي ============================ */
    const planPrompt = (desc)=>`
${UAE_COMPLIANCE}
أنت خبير تربية طفل وسلامة رقمية. حلّل وصف وليّ الأمر التالي:
"${desc}"
أرجع JSON بالعربية فقط (بدون أي نص خارج JSON) بالشكل:
{
 "analysisSummary": "جملة واحدة مختصرة",
 "needsHypothesis": ["3 نقاط فرضية دقيقة للاحتياجات"],
 "planSteps": ["3 خطوات تدريبية متدرجة وقابلة للقياس"],
 "initialAssessment": {
   "intro": "رسالة مطمئنة للطفل قبل الاختبار",
   "items": [
     {"type":"choice","q":"سؤال شعوري مرتبط بالمشكلة","options":["تمام","شوية","صعب"],"map":{"تمام":0,"شوية":1,"صعب":2}},
     {"type":"roleplay","q":"موقف قصير لتجربة سلوك مستهدف","success_hint":"تلميح تشجيعي"},
     {"type":"selfCheck","q":"كم درجة ثقتك الآن؟ (0-10)","scaleMin":0,"scaleMax":10}
   ],
   "scoring":"كيف نحسب مستوى الاحتياج (عالي/متوسط/منخفض)",
   "safeguards":"متى نوقف الحوار ونعطي تعليمات تصعيد"
 }
}
التزم بالدقة، ولا تفترض معلومات غير موجودة.
`;

    const chatSystem = ()=>{
      const lang = state.language==='ar' ? 'Emirati Arabic' : 'English';
      const persona = (()=>{
        if(state.gender==='ذكر'){
          if(state.ageGroup==='3-7') return {p:'Saif',style:'game'};
          if(state.ageGroup==='8-12')return {p:'Rashid',style:'role-playing'};
          return {p:'Sultan',style:'simulation & discussion'};
        } else {
          if(state.ageGroup==='3-7') return {p:'Noora',style:'game'};
          if(state.ageGroup==='8-12')return {p:'Mariam',style:'role-playing'};
          return {p:'Amna',style:'simulation & discussion'};
        }
      })();
      return `
${UAE_COMPLIANCE}
ROLE: أنت ${persona.p} مرشد داعم.
CHILD: "${state.name}" (${state.gender})، فئة ${state.ageGroup}.
PLAN: ${JSON.stringify(state.trainingPlan||{})}
ASSESSMENT: ${JSON.stringify(state.assessment?.result||{})}
STRICT:
1) استخدم ${lang} فقط.
2) المنهجية: Intro → Practice → Mission → Follow-up. أسلوب: ${persona.style}.
3) اربط كل رد بمدخلات الوالدين/الخطة/الاختبار. لا تستخدم قوالب ثابتة.
4) قائمة خيارات الطفل تكون مشاعر/ردود فعل فقط، سطر فارغ ثم عناصر تبدأ بـ "- ".
5) عند مؤشرات خطر: أوقف التقدم وقدّم رسالة جاهزة لوليّ الأمر للتصعيد.
`;
    };

    /* ============================ اتصال الدالة ============================ */
    async function callAI(payload){
      const r = await fetch(API_PROXY_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
      if(!r.ok){ let e=''; try{const j=await r.json(); e=j.error||r.statusText;}catch{e=r.statusText;} throw new Error(e); }
      return r.json();
    }

    /* ============================ توليد الخطة + دورة الموافقة ============================ */
    async function generatePlan(isModification){
      let fullDescription="";
      if(isModification){
        const reason = dom.plan-change-reason.value.trim();
        if(reason.length<10){ dom.plan-change-reason.focus(); return; }
        fullDescription = (state.parentDescription||'') + ` | أسباب التعديل: ${reason}`;
      }else{
        fullDescription = `الشخصية: ${dom.personalityInput.value.trim()} | التحديات: ${dom.challengesInput.value.trim()}`;
        state.parentDescription = fullDescription;
      }

      showScreen('plan-review-screen');
      dom.loadingSpinner.style.display='flex'; dom.planContent.classList.add('hidden');

      try{
        const result = await callAI({ systemInstruction: planPrompt(fullDescription), history: [] });
        let text = (result.text||'').replace(/```json|```/g,'').trim();
        const json = JSON.parse(text);
        state.trainingPlan = json;
        state.assessment = { spec: json.initialAssessment, result:null, answers:[] };
        renderPlan(json);
      }catch(e){
        state.trainingPlan = { analysisSummary:'طفل حساس يحتاج تمهيداً اجتماعياً تدريجياً.', needsHypothesis:['تمارين تحية قصيرة','تعزيز ثقة البدء','تجربة لعب مشتركة'], planSteps:['قل "مرحباً" بثقة','اسأل سؤالاً بسيطاً','ادعُ صديقاً لنشاط'], initialAssessment:{ intro:'نجرب أسئلة بسيطة.', items:[{type:'choice',q:'كيف تحس لما تبدأ كلام؟',options:['تمام','شوية','صعب'],map:{'تمام':0,'شوية':1,'صعب':2}},{type:'roleplay',q:'سلّم على زميلك بصوت واضح.',success_hint:'ابتسامة + مرحباً'},{type:'selfCheck',q:'ثقتك من 0 إلى 10؟',scaleMin:0,scaleMax:10}], scoring:'≥2 نقاط = احتياج أعلى', safeguards:'لو ذكر الطفل إساءة/تنمّر نوقف ونوجه للتصعيد' } };
        state.assessment = { spec: state.trainingPlan.initialAssessment, result:null, answers:[] };
        renderPlan(state.trainingPlan);
      } finally {
        dom.loadingSpinner.style.display='none'; dom.planContent.classList.remove('hidden'); saveState();
      }
    }

    function renderPlan(plan){
      dom.ai-analysis-summary.textContent = plan.analysisSummary || '';
      dom.ai-needs-hypo.innerHTML = '';
      (plan.needsHypothesis||[]).forEach(n=>{ const li=document.createElement('li'); li.textContent=n; dom.ai-needs-hypo.appendChild(li); });
      dom.ai-plan-steps.innerHTML = '';
      (plan.planSteps||[]).forEach(s=>{ const li=document.createElement('li'); li.textContent=s; dom.ai-plan-steps.appendChild(li); });
    }

    function approvePlan(){
      state.currentPlanStep=0; state.chatHistory=[];
      saveState(); updateUi(); showScreen('home-screen');
      // مباشرة: بدء الاختبار الأولي مع الطفل
      initiateChat(true); startInitialAssessment();
    }

    /* ============================ الاختبار الأولي ============================ */
    function startInitialAssessment(){
      const spec = state.assessment?.spec; if(!spec) return;
      const intro = spec.intro || (state.language==='ar'?'خلّينا نعمل اختباراً قصيراً يساعدنا نعرف اللي ينفعك أكثر.':'Let’s do a short check-in.');
      pushModel(intro + '\n\n- موافق\n- متردد');
      showUserOptions('- موافق\n- متردد');
    }

    function scoreAssessment(){
      const items = state.assessment?.spec?.items||[];
      let score=0;
      items.forEach((it,idx)=>{
        const a=state.assessment.answers[idx];
        if(it.type==='choice' && it.map && a in it.map) score += it.map[a];
        if(it.type==='selfCheck' && typeof a==='number') score += a>=7?2:(a>=4?1:0);
      });
      const level = score>=3 ? 'احتياج مرتفع' : (score>=1 ? 'احتياج متوسط' : 'احتياج منخفض');
      state.assessment.result = { score, level, at: Date.now() };
      saveState();
    }

    /* ============================ محادثة ============================ */
    function addMessage(text,role='model'){
      const el=document.createElement('div');
      el.className=`chat-bubble max-w-[80%] rounded-2xl p-3 ${role==='user'?'bg-sky-500 text-white self-end':'bg-slate-200 text-slate-800 self-start'}`;
      el.innerText=text; dom.chatMessages.appendChild(el);
      setTimeout(()=>dom.chatMessages.scrollTop=dom.chatMessages.scrollHeight,50);
    }
    function showTyping(){ const el=`<div id="typing-indicator" class="chat-bubble self-start flex items-center gap-1 bg-slate-200 rounded-2xl p-3"><div class="typing-indicator"><span class="w-2 h-2 bg-slate-400 rounded-full inline-block"></span><span class="w-2 h-2 bg-slate-400 rounded-full inline-block"></span><span class="w-2 h-2 bg-slate-400 rounded-full inline-block"></span></div></div>`; dom.chatMessages.insertAdjacentHTML('beforeend',el); dom.chatMessages.scrollTop=dom.chatMessages.scrollHeight; }
    function hideTyping(){ document.getElementById('typing-indicator')?.remove(); }
    function showUserOptions(optionsText){
      dom.chatOptionsContainer.innerHTML='';
      if(!optionsText) return;
      const options = optionsText.split('\n').map(o=>o.trim().replace(/^- /,'')).filter(Boolean);
      options.forEach(txt=>{
        const b=document.createElement('button');
        b.className='w-full text-sky-700 bg-sky-100 font-medium py-2 px-3 rounded-lg text-center hover:bg-sky-200 transition-colors text-sm';
        b.innerText=txt;
        b.addEventListener('click',()=>handleUserChoice(txt));
        dom.chatOptionsContainer.appendChild(b);
      });
    }
    function handleUserChoice(choiceText){
      addMessage(choiceText,'user');
      state.chatHistory.push({role:'user',parts:[{text:choiceText}]}); saveState();

      // التقاط إجابات الاختبار الأولي
      const spec = state.assessment?.spec;
      if(spec && !state.assessment.result){
        const items = spec.items||[];
        // محاولة تحويل رقم
        const n = Number(choiceText);
        state.assessment.answers.push(!Number.isNaN(n) && choiceText.match(/^\d+$/) ? n : choiceText);
        if(state.assessment.answers.length>=items.length){ scoreAssessment(); }
      }
      getChatResponse(choiceText);
    }

    function processChatResponse(text,isReloading=false){
      const [main,...rest] = text.split(/\n\n/);
      const opts = rest.join('\n\n');
      if(!isReloading){
        addMessage(main||'', 'model');
        state.chatHistory.push({role:'model',parts:[{text}]}); saveState();
      }
      showUserOptions(opts);
    }
    function pushModel(text){ addMessage(text,'model'); state.chatHistory.push({role:'model',parts:[{text}]}); saveState(); }

    async function getChatResponse(userMessage){
      showTyping(); dom.chatOptionsContainer.innerHTML='';
      try{
        const result = await callAI({ systemInstruction: chatSystem(), history: state.chatHistory });
        const reply = result.text || (state.language==='ar'?'عفواً، لم أفهم.':'Sorry, I didn’t understand.');
        hideTyping(); processChatResponse(reply);
      }catch(e){
        hideTyping(); addMessage(state.language==='ar'?'تعذّر الاتصال مؤقتاً.':'Temporary connection issue.','model');
      }
    }

    function initiateChat(fromAuto){
      showScreen('chat-screen'); dom.chatMessages.innerHTML='';
      if(state.chatHistory.length){
        state.chatHistory.forEach(m=>addMessage(m.parts[0].text,m.role));
        const last=state.chatHistory[state.chatHistory.length-1];
        if(last.role==='model') processChatResponse(last.parts[0].text,true);
      }else{
        const hello = state.language==='ar'?`مرحباً يا ${state.aiName}، أنا ${state.name} وجاهز للبدء.`:`Hi ${state.aiName}, I'm ${state.name} and ready to start.`;
        if(fromAuto){ pushModel(hello); } else { handleUserChoice(hello); }
      }
    }

    /* ============================ لغة وواجهة ============================ */
    function updateUi(){
      if(!state?.name) return;
      const t={
        ar:{g:`مرحباً بك يا ${state.name}`,m:`هدفنا:`,ready:`جاهز لمغامرة اليوم؟`,ai:`أهلاً بك! أنا ${state.aiName}`,desc:{'ذكر':'رفيجك الرقمي اللي بيساعدك في كل خطوة.','أنثى':'رفيجتج الرقمية اللي بتساعدج في كل خطوة.'},chat:`ابدأ الدردشة مع ${state.aiName}`,ph:'اكتب ردك هنا...'},
        en:{g:`Welcome, ${state.name}`,m:`Our goal:`,ready:`Ready for today’s adventure?`,ai:`Hey! I'm ${state.aiName}`,desc:{'ذكر':'Your digital buddy to help you every step.','أنثى':'Your digital buddy to help you every step.'},chat:`Start chat with ${state.aiName}`,ph:'Type your reply here...'}
      };
      const lang=state.language; document.documentElement.lang=lang; document.documentElement.dir= lang==='ar'?'rtl':'ltr';
      dom.homeGreeting.textContent=t[lang].g;
      dom.homeAiNameIntro.textContent=t[lang].ai;
      dom.startChatBtnText.textContent=t[lang].chat;
      dom.homeIntroText.textContent=t[lang].desc[state.gender];
      dom.chatInput.placeholder=t[lang].ph;
      if(state.trainingPlan?.planSteps?.[state.currentPlanStep]) dom.homeMissionStatus.textContent=`${t[lang].m} ${state.trainingPlan.planSteps[state.currentPlanStep]}`; else dom.homeMissionStatus.textContent=t[lang].ready;
    }

    /* ============================ بدء التشغيل ============================ */
    function init(){
      const returning = loadState();
      if(returning && state.name){ updateUi(); showScreen('home-screen'); }
      else { resetState(); }
      lucide.createIcons();
    }
    init();
  });
  </script>
</body>
</html>
