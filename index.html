<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>صديقي الذكي — مشروع مدرسي (مدرسة الإمارات الوطنية)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <!-- خط عربي مريح للقراءة -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{ --card: rgba(248,250,252,.96); }
    html,body{height:100%;margin:0;padding:0;overscroll-behavior-y:contain}
    body{font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif;line-height:1.9;-webkit-tap-highlight-color:transparent}

    /* خلفية تعبّر عن الطفولة الإماراتية (ثابتة) */
    #app-wrapper{
      background-image:
        linear-gradient( rgba(245,248,252,.92), rgba(245,248,252,.94) ),
        url('https://images.unsplash.com/photo-1584438784894-089d6a62b8a2?q=80&w=1920&auto=format&fit=crop'); /* أطفال خليج/مدرسة */
      background-size:cover;background-position:center;background-attachment:fixed;
    }
    #app-container{height:100%;height:100dvh}
    .screen,.modal{display:none}.screen.active,.modal.active{display:flex}
    .bg-screen{background:var(--card);backdrop-filter:blur(3px)}
    .chat-bubble{animation:pop .22s cubic-bezier(.2,.9,.3,1.4)}
    @keyframes pop{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
    #chat-messages::-webkit-scrollbar{width:6px}
    #chat-messages::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:10px}
    .age-btn.selected,.gender-btn.selected{border-color:#0ea5e9;background:#f0f9ff;color:#0284c7}
    #continue-profile-btn:disabled,#analyze-btn:disabled{background:#94a3b8;cursor:not-allowed}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .6rem;border-radius:9999px;font-size:.75rem}
    .brand-gradient{background:linear-gradient(135deg,#0ea5e9 0%,#14b8a6 100%);-webkit-background-clip:text;background-clip:text;color:transparent}
    .hit{min-height:44px;min-width:44px}
    @media (orientation:landscape){ #app-container{max-width:960px} #chat-messages{padding-bottom:.25rem} }
    @media (min-width:1024px){ #app-container{max-width:1024px} }
    @media (max-width:360px){ :root{font-size:15px} #chat-form input{font-size:14px} }

    /* Modal */
    .modal-backdrop{background:rgba(0,0,0,.45);backdrop-filter:blur(2px)}
    .modal-card{animation:zoom .18s ease}
    @keyframes zoom{from{transform:scale(.94);opacity:.6}to{transform:scale(1);opacity:1}}
  </style>
</head>
<body class="bg-slate-200 text-slate-800 antialiased">

  <div id="app-wrapper">
    <div id="app-container" class="w-full max-w-md md:max-w-lg mx-auto bg-transparent shadow-lg flex flex-col overflow-hidden relative">
      <main id="main" class="flex-grow relative flex flex-col"></main>

      <footer class="w-full shrink-0 bg-white/75 backdrop-blur border-t border-slate-200">
        <div class="px-3 py-2 text-[11px] sm:text-xs flex flex-col sm:flex-row items-center justify-between gap-2">
          <div class="flex items-center gap-2">
            <span class="badge bg-cyan-100 text-cyan-700 font-semibold"><i data-lucide="shield-check" class="w-3.5 h-3.5"></i> أمان الطفل أولاً</span>
            <span class="badge bg-emerald-100 text-emerald-700 font-semibold"><i data-lucide="sprout" class="w-3.5 h-3.5"></i> توجيه تربوي إيجابي</span>
          </div>
          <div class="text-center leading-tight">
            <div class="font-bold brand-gradient">© صديقي الذكي — مشروع مدرسي</div>
            <div class="text-slate-500">مدرسة الإمارات الوطنية — حقوق الطالب: <span class="font-bold">يوسف سالمين</span></div>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <!-- Modal PIN لحذف المحادثة -->
  <div id="pin-modal" class="modal fixed inset-0 modal-backdrop items-center justify-center p-4">
    <div class="modal-card bg-white w-full max-w-sm rounded-2xl shadow-xl p-6 text-center">
      <i data-lucide="shield-alert" class="w-14 h-14 text-amber-500 mx-auto mb-3"></i>
      <h3 class="text-lg font-bold mb-1">تأكيد الحذف</h3>
      <p class="text-slate-600 text-sm mb-4">أدخل رمز الحماية لحذف المحادثة:</p>
      <input id="pin-input" type="tel" maxlength="4" placeholder="••••" class="w-full text-center tracking-[1em] bg-slate-100 border-2 border-slate-200 rounded-xl p-3 text-2xl focus:outline-none focus:border-sky-400">
      <p id="pin-error" class="text-red-500 text-xs mt-2 hidden">رمز غير صحيح</p>
      <div class="grid grid-cols-2 gap-3 mt-5">
        <button id="pin-cancel" class="bg-slate-200 text-slate-800 font-bold py-2 rounded-full hit">إلغاء</button>
        <button id="pin-ok" class="bg-red-500 text-white font-bold py-2 rounded-full hit">حذف</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const main = document.getElementById('main');
    const pinModal = document.getElementById('pin-modal');
    const PIN_CODE = '2222';

    /* ================== الشــاشــات ================== */
    main.innerHTML = `
      <!-- صفحة البداية بخلفية ثابتة -->
      <section id="start-screen" class="screen active bg-transparent flex-col items-center justify-center p-8 text-center">
        <div class="w-full max-w-md bg-white/85 rounded-2xl shadow-lg p-6">
          <div class="w-20 h-20 rounded-full bg-sky-50 border border-sky-100 flex items-center justify-center mx-auto mb-3"><i data-lucide="bot" class="w-10 h-10 text-sky-600"></i></div>
          <h1 class="text-3xl font-bold mb-2">صديقي الذكي</h1>
          <p class="text-slate-600 mb-6">مرشد رقمي آمن يساعد طفلك على تخطي التحديات الاجتماعية بخطوات قصيرة ومناسبة للعمر.</p>
          <button id="start-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-8 rounded-full shadow-lg hit">ابدأ</button>
        </div>
      </section>

      <!-- التعريف والالتزامات -->
      <section id="intro-screen" class="screen bg-screen flex-col items-stretch p-8 overflow-y-auto">
        <i data-lucide="shield-check" class="w-16 h-16 text-sky-500 mx-auto mb-4"></i>
        <h2 class="text-2xl font-bold text-center mb-2">كيف نعمل؟ والتزاماتنا</h2>
        <p class="text-slate-600 text-center mb-6">نربط وصف وليّ الأمر بتحليل ذكي، نجمع بيانات من الطفل بلطف لكشف احتياجات خفية، ثم ننتقل لتدريب موجّه متدرج.</p>
        <ul class="space-y-3 text-sm text-slate-700">
          <li class="flex items-start gap-3"><i data-lucide="scale" class="w-5 h-5 text-sky-500 mt-0.5"></i><span><b>امتثال:</b> الالتزام بقوانين الإمارات والمعايير الدولية لسلامة الطفل.</span></li>
          <li class="flex items-start gap-3"><i data-lucide="database" class="w-5 h-5 text-sky-500 mt-0.5"></i><span><b>خصوصية:</b> لا نطلب بيانات تعريفية؛ التخزين محلي؛ لا تُشارك المحادثات.</span></li>
          <li class="flex items-start gap-3"><i data-lucide="stethoscope" class="w-5 h-5 text-sky-500 mt-0.5"></i><span><b>حدود:</b> إرشاد تربوي—not تشخيص طبي/نفسي. عند مؤشرات الخطر نوصي بالتصعيد لمختص مرخّص.</span></li>
          <li class="flex items-start gap-3"><i data-lucide="child" class="w-5 h-5 text-sky-500 mt-0.5"></i><span><b>الهدف:</b> تمكين الطفل تدريجياً للخروج من المشكلة عبر تمارين قابلة للقياس.</span></li>
        </ul>
        <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <button id="intro-back" class="bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-full hover:bg-slate-300 hit">رجوع</button>
          <button id="intro-accept" class="bg-sky-600 text-white font-bold py-3 px-6 rounded-full hover:bg-sky-700 hit">موافق</button>
        </div>
      </section>

      <!-- الملف الشخصي -->
      <section id="profile-setup-screen" class="screen bg-screen flex-col p-8 overflow-y-auto">
        <i data-lucide="user-round-check" class="w-16 h-16 text-sky-500 mx-auto mb-6"></i>
        <h2 class="text-2xl font-bold text-center mb-2">ملف البطل الشخصي</h2>
        <div class="w-full space-y-6">
          <div>
            <label class="font-bold mb-2 block" for="child-name-input">اسم الطفل/الطفلة</label>
            <input id="child-name-input" type="text" class="w-full bg-white/90 border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-sky-400" placeholder="مثال: خالد أو علياء" aria-label="اسم الطفل">
          </div>
          <div>
            <p class="font-bold mb-2">الفئة العمرية</p>
            <div class="grid grid-cols-3 gap-3">
              <button data-age="3-7"  class="age-btn bg-white/90 border-2 border-slate-200 p-3 rounded-xl font-bold hit" aria-pressed="false">3–7</button>
              <button data-age="8-12" class="age-btn bg-white/90 border-2 border-slate-200 p-3 rounded-xl font-bold hit" aria-pressed="false">8–12</button>
              <button data-age="13-18" class="age-btn bg-white/90 border-2 border-slate-200 p-3 rounded-xl font-bold hit" aria-pressed="false">13–18</button>
            </div>
          </div>
          <div>
            <p class="font-bold mb-2">الجنس</p>
            <div class="grid grid-cols-2 gap-3">
              <button data-gender="ذكر"  class="gender-btn bg-white/90 border-2 border-slate-200 p-3 rounded-xl font-bold hit" aria-pressed="false">ذكر</button>
              <button data-gender="أنثى" class="gender-btn bg-white/90 border-2 border-slate-200 p-3 rounded-xl font-bold hit" aria-pressed="false">أنثى</button>
            </div>
          </div>
        </div>
        <div class="mt-8">
          <button id="continue-profile-btn" class="w-full bg-sky-600 text-white font-bold py-3 px-6 rounded-full text-lg shadow-lg hit" disabled>متابعة</button>
        </div>
      </section>

      <!-- إدخال ولي الأمر -->
      <section id="parent-input-screen" class="screen bg-screen flex-col p-8 overflow-y-auto">
        <i data-lucide="file-text" class="w-16 h-16 text-sky-500 mx-auto mb-6"></i>
        <h2 class="text-2xl font-bold text-center mb-2">رؤية وليّ الأمر</h2>
        <p class="text-slate-600 text-center mb-6">كلما كانت التفاصيل أدق، كانت الخطة أفضل. لا نطلب بيانات تعريفية.</p>
        <div class="space-y-6">
          <div><label class="font-bold mb-2 block" for="child-personality">1) شخصية الطفل</label><textarea id="child-personality" rows="3" class="w-full bg-white/90 border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-sky-400" placeholder="مثال: مبدع، هادئ، حساس، حركي..." aria-label="شخصية الطفل"></textarea></div>
          <div><label class="font-bold mb-2 block" for="child-challenges">2) أهم التحديات الاجتماعية</label><textarea id="child-challenges" rows="4" class="w-full bg-white/90 border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-sky-400" placeholder="مثال: صعوبة تكوين صداقات، خجل من المشاركة..." aria-label="التحديات الاجتماعية"></textarea></div>
        </div>
        <div class="mt-8">
          <button id="analyze-btn" class="w-full bg-sky-600 text-white font-bold py-3 px-6 rounded-full text-lg shadow-lg hover:bg-sky-700 hit" disabled>تحليل وإنشاء الخطة الأولية</button>
        </div>
      </section>

      <!-- مراجعة الخطة -->
      <section id="plan-review-screen" class="screen bg-screen flex-col p-8 overflow-y-auto">
        <div id="loading-spinner" class="m-auto text-center items-center justify-center">
          <i data-lucide="loader-circle" class="w-16 h-16 text-sky-500 mx-auto mb-4 animate-spin"></i>
          <h3 class="text-xl font-bold">إنشاء خطة أولية دقيقة...</h3>
          <p class="text-slate-500">يستغرق لحظات.</p>
        </div>
        <div id="plan-content" class="hidden flex-col">
          <i data-lucide="clipboard-check" class="w-16 h-16 text-green-500 mx-auto mb-6"></i>
          <h2 class="text-2xl font-bold text-center mb-2">الخطة المقترحة (للمراجعة)</h2>
          <p class="text-slate-600 text-center mb-6">اختر: <b>موافقة</b> أو <b>طلب تعديل</b>. عند التعديل نجمع الأسباب ونولّد خطة جديدة.</p>
          <div class="bg-white border border-slate-200 rounded-xl p-4 space-y-4">
            <div><h4 class="font-bold flex items-center gap-2"><i data-lucide="user-round-cog" class="w-5 h-5 text-sky-600"></i>ملخص التحليل</h4><p id="ai-analysis-summary" class="text-slate-700 mt-1"></p></div>
            <div><h4 class="font-bold flex items-center gap-2"><i data-lucide="target" class="w-5 h-5 text-sky-600"></i>فرضية الاحتياجات</h4><ul id="ai-needs-hypo" class="list-disc list-inside mt-2 space-y-1 text-slate-700"></ul></div>
            <div><h4 class="font-bold flex items-center gap-2"><i data-lucide="list-checks" class="w-5 h-5 text-sky-600"></i>خطوات التدريب</h4><ul id="ai-plan-steps" class="list-decimal list-inside mt-2 space-y-1 text-slate-700"></ul></div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-6">
            <button id="approve-plan-btn" class="w-full bg-emerald-600 text-white font-bold py-3 px-6 rounded-full shadow hover:bg-emerald-700 hit">موافقة على الخطة</button>
            <button id="request-edit-btn" class="w-full bg-amber-500 text-white font-bold py-3 px-6 rounded-full shadow hover:bg-amber-600 hit">طلب تعديل</button>
          </div>
        </div>
      </section>

      <!-- أسباب التعديل -->
      <section id="plan-change-screen" class="screen bg-screen flex-col p-8 overflow-y-auto">
        <i data-lucide="edit" class="w-16 h-16 text-sky-500 mx-auto mb-6"></i>
        <h2 class="text-2xl font-bold text-center mb-2">أسباب التعديل</h2>
        <textarea id="plan-change-reason" rows="6" class="w-full bg-white/90 border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-sky-400" placeholder="اذكر الأسباب المحددة: صعوبة خطوة، مواقف واقعية، أهداف جديدة، حساسية ثقافية/مدرسية..."></textarea>
        <div class="mt-6">
          <button id="re-analyze-btn" class="w-full bg-sky-600 text-white font-bold py-3 px-6 rounded-full text-lg shadow hover:bg-sky-700 hit">إعادة التحليل وإنتاج خطة جديدة</button>
        </div>
      </section>

      <!-- الصفحة الرئيسية -->
      <section id="home-screen" class="screen bg-transparent flex-col p-6">
        <header class="flex justify-between items-center mb-6">
          <div><p id="home-greeting" class="text-slate-500"></p><h2 id="home-mission-status" class="text-2xl font-bold">جاهز لمغامرة اليوم؟</h2></div>
          <button id="reset-app-btn" class="p-2 rounded-full bg-white/60 hover:bg-red-100 text-red-500 hit" title="حذف المحادثة"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
        </header>
        <main class="flex-grow flex flex-col justify-center items-center text-center">
          <div class="w-44 h-44 md:w-48 md:h-48 bg-white/60 backdrop-blur-sm rounded-full flex items-center justify-center mb-6"><i data-lucide="bot" class="w-24 h-24 md:w-28 md:h-28 text-sky-600"></i></div>
          <h3 id="home-ai-name-intro" class="text-2xl font-bold mb-2"></h3>
          <p id="home-intro-text" class="text-slate-500 max-w-xs mb-6"></p>
          <button id="initiate-chat-btn" class="w-full bg-sky-600 text-white font-bold py-4 px-6 rounded-full text-lg shadow flex items-center justify-center gap-2 hit"><i data-lucide="message-circle"></i><span id="start-chat-btn-text"></span></button>
        </main>
      </section>

      <!-- المحادثة -->
      <section id="chat-screen" class="screen bg-screen flex-col">
        <header class="bg-white p-4 flex items-center gap-4 border-b border-slate-200">
          <button id="end-chat-btn" class="p-2 rounded-full hover:bg-slate-100 hit"><i data-lucide="arrow-right"></i></button>
          <div class="w-10 h-10 bg-gradient-to-br from-cyan-100 to-sky-200 rounded-full flex items-center justify-center"><i data-lucide="bot" class="w-6 h-6 text-sky-600"></i></div>
          <div class="flex-grow"><h3 id="chat-header-name" class="font-bold"></h3><p class="text-xs text-green-500 font-medium flex items-center gap-1"><span class="w-2 h-2 bg-green-400 rounded-full"></span>متصل</p></div>
          <button id="language-toggle-btn" class="p-2 rounded-full hover:bg-slate-100 text-slate-600 hit" title="تبديل اللغة"><i data-lucide="languages" class="w-5 h-5"></i></button>
        </header>
        <main id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto"></main>
        <footer class="p-4 border-t border-slate-200 bg-white/85 backdrop-blur-sm">
          <p id="free-text-hint" class="text-[12px] text-slate-500 mb-2 hidden"></p>
          <div id="chat-options-container" class="mb-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2"></div>
          <form id="chat-form" class="flex items-center gap-2">
            <input id="chat-input" type="text" placeholder="اكتب ردك هنا..." class="w-full bg-white border-2 border-slate-200 rounded-full py-2 px-4 focus:outline-none focus:border-sky-400" aria-label="اكتب ردك"/>
            <button type="submit" class="bg-sky-600 text-white rounded-full p-3 hover:bg-sky-700 hit" aria-label="إرسال"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
          </form>
        </footer>
      </section>
    `;

    const $ = (id) => document.getElementById(id);
    const show = (id) => document.querySelectorAll('.screen').forEach(s => s.classList.toggle('active', s.id === id));
    const showModal = (el)=> el.classList.add('active');
    const hideModal = (el)=> el.classList.remove('active');

    /* =============== الحالة =============== */
    const STORAGE = 'sadiki-ai-v25';
    let state = {};
    const save = ()=>{ try{ localStorage.setItem(STORAGE, JSON.stringify(state)); }catch{} };
    const load = ()=>{ try{ const d=localStorage.getItem(STORAGE); if(d){ state=JSON.parse(d); return true; } }catch{} return false; };
    const resetState = ()=> state = {
      language:'ar', age:null, gender:null, name:null, aiName:null,
      parentDesc:null, plan:null, chat:[], step:0, assessment:null,
      askedQuestions:[]
    };

    /* امتثال وسلامة الإمارات */
    const UAE_COMPLIANCE = `
- التزم بقوانين الإمارات والمعايير الدولية لسلامة الطفل.
- لا تقدم تشخيصاً طبياً/نفسيّاً؛ عند مؤشرات الخطر وجّه لوليّ الأمر/المدرسة ومختص مرخّص.
- لا تطلب بيانات تعريفية (عنوان/مدرسة/أرقام).
- أي إساءة/تنمّر/إيذاء: أوقف التقدّم وقدّم رسالة تصعيد.
`;

    const getAiName = (age,gender)=>{
      if(age==='3-7') return gender==='ذكر'?'سيف':'نورة';
      if(age==='8-12') return gender==='ذكر'?'راشد':'مريم';
      if(age==='13-18') return gender==='ذكر'?'سلطان':'آمنة';
      return 'صديقي الذكي';
    };

    const dom = {
      startBtn: $('start-btn'), introBack: $('intro-back'), introAccept: $('intro-accept'),
      ageBtns: [...document.querySelectorAll('.age-btn')], genderBtns: [...document.querySelectorAll('.gender-btn')],
      nameInput: $('child-name-input'), continueProfile: $('continue-profile-btn'),
      personality: $('child-personality'), challenges: $('child-challenges'), analyzeBtn: $('analyze-btn'),
      loading: $('loading-spinner'), planContent: $('plan-content'),
      planSummary: $('ai-analysis-summary'), needsList: $('ai-needs-hypo'), stepsList: $('ai-plan-steps'),
      approve: $('approve-plan-btn'), requestEdit: $('request-edit-btn'),
      reason: $('plan-change-reason'), reAnalyze: $('re-analyze-btn'),
      greeting: $('home-greeting'), aiIntro: $('home-ai-name-intro'), introText: $('home-intro-text'),
      mission: $('home-mission-status'), startChat: $('initiate-chat-btn'),
      chatMessages: $('chat-messages'), chatOptions: $('chat-options-container'),
      chatForm: $('chat-form'), chatInput: $('chat-input'),
      endChat: $('end-chat-btn'), languageToggle: $('language-toggle-btn'),
      resetApp: $('reset-app-btn'), freeTextHint: $('free-text-hint'),
      pinInput: $('pin-input'), pinError: $('pin-error'), pinOk: $('pin-ok'), pinCancel: $('pin-cancel')
    };

    /* =============== تنقّل البداية =============== */
    dom.startBtn.addEventListener('click', ()=> show('intro-screen'));
    dom.introBack.addEventListener('click', ()=> show('start-screen'));
    dom.introAccept.addEventListener('click', ()=> show('profile-setup-screen'));

    /* =============== الملف الشخصي =============== */
    dom.ageBtns.forEach(b=>b.addEventListener('click',e=>{
      state.age=e.currentTarget.dataset.age; dom.ageBtns.forEach(x=>x.classList.remove('selected')); e.currentTarget.classList.add('selected'); e.currentTarget.setAttribute('aria-pressed','true'); validateProfile();
    }));
    dom.genderBtns.forEach(b=>b.addEventListener('click',e=>{
      state.gender=e.currentTarget.dataset.gender; dom.genderBtns.forEach(x=>x.classList.remove('selected')); e.currentTarget.classList.add('selected'); e.currentTarget.setAttribute('aria-pressed','true'); validateProfile();
    }));
    dom.nameInput.addEventListener('input', validateProfile);
    dom.continueProfile.addEventListener('click', ()=>{
      if(dom.continueProfile.disabled) return;
      state.name = dom.nameInput.value.trim();
      state.aiName = getAiName(state.age, state.gender);
      show('parent-input-screen');
    });
    function validateProfile(){
      dom.continueProfile.disabled = !(dom.nameInput.value.trim().length>1 && state.age && state.gender);
    }

    /* =============== إدخال ولي الأمر → خطة =============== */
    dom.personality.addEventListener('input', validateParent);
    dom.challenges.addEventListener('input', validateParent);
    function validateParent(){ dom.analyzeBtn.disabled = !(dom.personality.value.trim().length>5 && dom.challenges.value.trim().length>10); }

    dom.analyzeBtn.addEventListener('click', ()=> generatePlan(false));
    dom.reAnalyze.addEventListener('click', ()=> generatePlan(true));

    /* =============== بروكسي Gemini (وظيفتك) =============== */
    async function callAIProxy({ systemInstruction, messages, history, mode='chat', forceLang='ar' }) {
      let outgoing = [];
      if (Array.isArray(messages) && messages.length) {
        outgoing = messages;
      } else if (Array.isArray(history)) {
        outgoing = history.map(m => ({ role: m.role === 'user' ? 'user' : 'model', content: (m.parts?.[0]?.text || '') }));
      }
      const body = {
        system: systemInstruction || '',
        messages: outgoing,
        model: "auto",
        mode,
        force_lang: forceLang,
        guard_level: "strict",
        long: true,
        max_chunks: 4,
        stream: false,
        timeout_ms: 28000
      };
      const resp = await fetch('/.netlify/functions/gemini-proxy', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
      });
      if (!resp.ok) {
        let err; try { err = await resp.json(); } catch { err = { error: resp.statusText, status: resp.status }; }
        throw err;
      }
      return resp.json();
    }

    /* =============== Prompts (احترافي) =============== */
    // توجيه شامل يجمع البيانات ثم يتحوّل للتدريب
    const MASTER_GUIDE = ()=> `
${UAE_COMPLIANCE}
مهمّتك: مرشد تربوي رقمي آمن للطفل. اعمل على مرحلتين:
1) جمع بيانات دقيقة ومناسبة للعمر لاكتشاف الشخصية والتحديات الحقيقية (حتى لو خفيت على الوالدين). شجّع الطفل على الصراحة وعدم الخوف. اسأل أسئلة طبيعية ولطيفة بصيغة سؤال—not أوامر—not "اختر". بعد السؤال أعرض 3–4 مقترحات شعورية مختصرة ومتنافية تبدأ بـ "- " فقط، ثم سطر ثابت: "إن لم تناسبك أي مقترح، اكتب شعورك بطريقتك." لا تُكرّر سؤالاً سبق طرحه.
2) بعد أن تتكوّن صورة واضحة، انتقل بسلاسة للتدريب: Intro → Practice (تمرين قصير) → Mission (مهمة واقعية صغيرة) → Follow-up. خصّص التدريب لحالة الطفل وذكّره بتقدّمه. حافظ على الأمان والامتثال؛ عند مؤشرات خطر أوقف التقدّم وقدّم رسالة تصعيد لوليّ الأمر/المدرسة.
اللغة: التزم بلغة الطفل الظاهرة فقط.`;

    const planPrompt = (desc)=>`
${UAE_COMPLIANCE}
أنت خبير تربية طفل وسلامة رقمية. حلّل وصف وليّ الأمر:
"${desc}"
أرجع JSON بالعربية فقط:
{
 "analysisSummary":"جملة مختصرة ودقيقة",
 "needsHypothesis":["3 نقاط فرضية دقيقة"],
 "planSteps":["3 خطوات تدريبية متدرجة وقابلة للقياس"],
 "initialAssessment":{
   "intro":"عرّف بنفسك باحترام وبأسلوب مطمئن. ذكّر بأن الصراحة شجاعة وأن لا أحد سيغضب منه.",
   "items":[
     {"type":"choice","q":"سؤال شعوري طبيعي حول موقف اجتماعي يهم الطفل","options":["أشعر أنه سهل","أحتاج شوية شجاعة","صعب اليوم"],"map":{"أشعر أنه سهل":0,"أحتاج شوية شجاعة":1,"صعب اليوم":2}},
     {"type":"roleplay","q":"موقف قصير للتجربة (تمثيل دور) بلطف","success_hint":"أحسنت! لاحظ كيف تغيّر إحساسك."},
     {"type":"selfCheck","q":"قيّم ثقتك الآن من 0 إلى 10 أو اكتب شعورك بكلماتك","scaleMin":0,"scaleMax":10}
   ],
   "scoring":"منهجية (مرتفع/متوسط/منخفض)",
   "safeguards":"متى نوقف الحوار ونصعّد"
 }
}`;

    // قواعد المحادثة: سؤال كنص فقط + خيارات كأزرار
    const chatRules = ()=> {
      const lang = state.language==='ar'?'Emirati Arabic':'English';
      const persona = (()=>{
        if(state.gender==='ذكر'){ if(state.age==='3-7') return {p:'Saif',s:'game'}; if(state.age==='8-12') return {p:'Rashid',s:'role-playing'}; return {p:'Sultan',s:'simulation & discussion'} }
        else { if(state.age==='3-7') return {p:'Noora',s:'game'}; if(state.age==='8-12') return {p:'Mariam',s:'role-playing'}; return {p:'Amna',s:'simulation & discussion'} }
      })();
      return `
${MASTER_GUIDE()}
ROLE: أنت ${persona.p}.
CHILD: "${state.name}" (${state.gender})، فئة ${state.age}.
PARENT_DESC: ${state.parentDesc||'-'}
PLAN: ${JSON.stringify(state.plan||{})}
ASSESSMENT: ${JSON.stringify(state.assessment?.result||{})}
STRICT OUTPUT:
- السؤال/الرسالة الرئيسية كنص فقط (لن نعرضها كزر).
- المقترحات إن وُجدت تكون في فقرة أخرى، وكل سطر يبدأ بـ "- ".
- لا تُكرّر سؤالاً سبق أن طُرح (لدينا ذاكرة للأسئلة).`;
    };

    /* =============== توليد الخطة =============== */
    async function generatePlan(isModification){
      let desc='';
      if(isModification){
        const reason = dom.reason.value.trim(); if(reason.length<10){ dom.reason.focus(); return; }
        desc = (state.parentDesc||'') + ` | أسباب التعديل: ${reason}`;
      }else{
        desc = `الشخصية: ${dom.personality.value.trim()} | التحديات: ${dom.challenges.value.trim()}`;
        state.parentDesc = desc;
      }

      show('plan-review-screen'); dom.loading.style.display='flex'; dom.planContent.classList.add('hidden');

      try{
        const { text } = await callAIProxy({
          systemInstruction: planPrompt(desc),
          messages: [{ role:"user", content: planPrompt(desc) }],
          mode:'plan',
          forceLang:'ar'
        });
        const plan = JSON.parse( (text||'').replace(/```json|```/g,'').trim() );
        state.plan = plan;
        state.assessment = { spec: plan.initialAssessment, result:null, answers:[] };
        renderPlan(plan);
        dom.loading.style.display='none'; dom.planContent.classList.remove('hidden'); save();
      }catch(e){
        dom.loading.style.display='none';
        $('plan-review-screen').innerHTML = `
          <div class="flex flex-col items-center justify-center text-center gap-3 py-12">
            <i data-lucide="wifi-off" class="w-16 h-16 text-amber-500"></i>
            <h3 class="text-xl font-bold">تعذّر إنشاء الخطة الآن</h3>
            <button id="retry-plan" class="bg-sky-600 text-white font-bold py-3 px-6 rounded-full hover:bg-sky-700 hit">إعادة المحاولة</button>
          </div>`;
        lucide.createIcons(); $('retry-plan').addEventListener('click', ()=>generatePlan(isModification));
      }
    }

    function renderPlan(plan){
      dom.planSummary.textContent = plan.analysisSummary||'';
      dom.needsList.innerHTML=''; (plan.needsHypothesis||[]).forEach(n=>{ const li=document.createElement('li'); li.textContent=n; dom.needsList.appendChild(li); });
      dom.stepsList.innerHTML=''; (plan.planSteps||[]).forEach(s=>{ const li=document.createElement('li'); li.textContent=s; dom.stepsList.appendChild(li); });
      dom.planContent.classList.remove('hidden');
    }

    dom.requestEdit.addEventListener('click', ()=> show('plan-change-screen'));
    dom.approve.addEventListener('click', ()=>{
      state.step=0; state.chat=[]; state.askedQuestions=[];
      save(); updateHome(); show('home-screen');
      beginAIOnboarding();
    });

    /* =============== بدء المحادثة/التقييم الأولي =============== */
    function beginAIOnboarding(){
      show('chat-screen');
      dom.chatMessages.innerHTML=''; dom.chatOptions.innerHTML='';
      dom.freeTextHint.textContent = 'يمكنك الضغط على مقترح أو كتابة شعورك بحرّية. إذا لم يناسبك أي مقترح، اكتب ما تشعر به بكلماتك.';
      dom.freeTextHint.classList.remove('hidden');

      // نرسل توجيهًا داخليًا للموديل فقط (لا يظهر للطفل)
      state.chat.push({ role:'user', parts:[{ text:'(internal:start_initial_assessment_and_warmup)' }] });
      save();
      respond();
    }

    function scoreAssessment(){
      const items = state.assessment?.spec?.items||[]; let score=0;
      items.forEach((it,i)=>{
        const a=state.assessment.answers[i];
        if(it.type==='choice' && it.map && a in it.map) score += it.map[a];
        if(it.type==='selfCheck' && typeof a==='number') score += a>=7?2:(a>=4?1:0);
      });
      const level = score>=3 ? 'احتياج مرتفع' : (score>=1 ? 'احتياج متوسط' : 'احتياج منخفض');
      state.assessment.result = { score, level, at: Date.now() }; save();
    }

    /* =============== المحادثة =============== */
    function addMsg(text, role='model'){
      const el=document.createElement('div');
      el.className=`chat-bubble max-w-[80%] rounded-2xl p-3 ${role==='user'?'bg-sky-600 text-white self-end':'bg-slate-200 text-slate-800 self-start'}`;
      el.innerText=text; dom.chatMessages.appendChild(el);
      setTimeout(()=>dom.chatMessages.scrollTop=dom.chatMessages.scrollHeight,30);
    }

    function normalizedQuestion(q){ return String(q||'').replace(/\s+/g,' ').trim().slice(0,220); }

    function showOptions(text){
      dom.chatOptions.innerHTML='';
      dom.freeTextHint.classList.remove('hidden');
      if(!text) return;

      // نأخذ فقط الأسطر التي تبدأ بـ "- " لضمان أنها خيارات وليست أسئلة
      const raw = text.split('\n')
        .map(t=>t.trim())
        .filter(t=>t.startsWith('- '))
        .map(t=>t.replace(/^- /,''));

      // قص إلى 4 خيارات مختلفة
      const uniq=[]; for(const k of raw){ if(!uniq.includes(k)){ uniq.push(k); if(uniq.length>=4) break; } }

      uniq.forEach(opt=>{
        const b=document.createElement('button');
        b.className='w-full text-sky-700 bg-sky-100 font-medium py-2 px-3 rounded-lg hover:bg-sky-200 text-sm hit';
        b.innerText=opt; b.addEventListener('click',()=>handleUser(opt));
        dom.chatOptions.appendChild(b);
      });

      // خيار كتابة رد حر
      const other=document.createElement('button');
      other.className='w-full bg-white border border-slate-300 font-medium py-2 px-3 rounded-lg hover:bg-slate-100 text-sm hit';
      other.innerText = (state.language==='ar') ? 'شيء آخر — سأكتب ردي' : 'Something else — I\'ll type';
      other.addEventListener('click',()=>{ dom.chatInput.focus(); });
      dom.chatOptions.appendChild(other);
    }

    function pushModel(text){
      const q = normalizedQuestion(text);
      const asked = new Set(state.askedQuestions || []);
      if(asked.has(q)){ return; }            // لا نكرّر السؤال
      addMsg(text,'model');
      asked.add(q);
      state.askedQuestions = Array.from(asked);
      state.chat.push({role:'model',parts:[{text}]}); save();
    }

    function showTyping(){
      const el=`<div id="typing" class="chat-bubble self-start bg-slate-200 p-3 rounded-2xl"><span class="inline-block w-2 h-2 bg-slate-500 rounded-full animate-pulse"></span></div>`;
      dom.chatMessages.insertAdjacentHTML('beforeend',el); dom.chatMessages.scrollTop=dom.chatMessages.scrollHeight;
    }
    function hideTyping(){ document.getElementById('typing')?.remove(); }

    async function respond(){
      showTyping();
      try{
        const outgoing = state.chat.map(m => ({ role:m.role==='user'?'user':'model', content: m.parts?.[0]?.text || '' }));
        const { text } = await callAIProxy({
          systemInstruction: chatRules(),
          messages: outgoing,
          mode:'default',
          forceLang: (state.language==='ar'?'ar':'en')
        });
        hideTyping();
        const [main,...rest]=(text||'').split(/\n\n/);  // السؤال/النص الطبيعي
        const optsText = rest.join('\n\n');             // فقرة الخيارات فقط
        if(main) pushModel(main);
        showOptions(optsText);
      }catch(e){
        hideTyping(); addMsg('توقف مؤقت في الاتصال. اضغط مقترحًا أو اكتب للمتابعة.','model');
      }
    }

    function handleUser(text){
      addMsg(text,'user'); state.chat.push({role:'user',parts:[{text}]}); save();

      // التقاط إجابات التقييم الأولي
      const spec = state.assessment?.spec;
      if(spec && !state.assessment.result){
        const last = text.trim();
        const asNumber = /^\d+$/.test(last) ? Number(last) : null;
        state.assessment.answers.push(asNumber ?? last);
        if(state.assessment.answers.length >= (spec.items||[]).length) scoreAssessment();
      }
      respond();
    }

    dom.chatForm.addEventListener('submit', e=>{ e.preventDefault(); const v=dom.chatInput.value.trim(); if(v){ handleUser(v); dom.chatInput.value=''; } });
    dom.endChat.addEventListener('click', ()=>{ show('home-screen'); updateHome(); });

    /* =============== واجهة الطفل =============== */
    function updateHome(){
      const t={ ar:{g:`مرحباً يا ${state.name}`,m:`هدفنا:`,ready:`جاهز لمغامرة اليوم؟`,ai:`أنا ${state.aiName}`,desc:{'ذكر':'رفيجك الرقمي اللي بيساعدك خطوة بخطوة.','أنثى':'رفيجتج الرقمية اللي بتساعدج خطوة بخطوة.'},chat:`ابدأ الدردشة مع ${state.aiName}`,ph:'اكتب ردك هنا...'},
               en:{g:`Welcome, ${state.name}`,m:`Our goal:`,ready:`Ready for today’s adventure?`,ai:`I'm ${state.aiName}`,desc:{'ذكر':'Your digital buddy to help you step by step.','أنثى':'Your digital buddy to help you step by step.'},chat:`Start chat with ${state.aiName}`,ph:'Type your reply here...'} };
      const L=t[state.language];
      $('home-greeting').textContent=L.g; $('home-ai-name-intro').textContent=L.ai; $('home-intro-text').textContent=L.desc[state.gender];
      $('start-chat-btn-text').textContent=L.chat; $('chat-input').placeholder=L.ph;
      $('home-mission-status').textContent = (state.plan?.planSteps?.[state.step]) ? `${L.m} ${state.plan.planSteps[state.step]}` : L.ready;
      $('chat-header-name').textContent = state.aiName;
    }

    $('language-toggle-btn').addEventListener('click', ()=>{
      state.language = state.language==='ar' ? 'en' : 'ar'; save(); updateHome();
      state.chat.push({role:'user',parts:[{text:`(System instruction: switch language to ${state.language}.)`}]}); respond();
    });
    dom.startChat.addEventListener('click', ()=>{
      show('chat-screen'); dom.chatMessages.innerHTML=''; dom.chatOptions.innerHTML='';
      dom.freeTextHint.classList.add('hidden');
      state.askedQuestions = state.askedQuestions || [];
      if(state.chat.length){
        state.chat.forEach(m=>addMsg(m.parts[0].text,m.role));
        const last=state.chat[state.chat.length-1]; if(last.role==='model'){ const [_,...rest]=last.parts[0].text.split(/\n\n/); showOptions(rest.join('\n\n')); }
      } else {
        beginAIOnboarding();
      }
    });

    /* =============== حذف المحادثة بالرمز 2222 =============== */
    dom.resetApp.addEventListener('click', ()=>{
      $('pin-input').value=''; $('pin-error').classList.add('hidden'); showModal(pinModal);
    });
    dom.pinCancel.addEventListener('click', ()=> hideModal(pinModal));
    dom.pinOk.addEventListener('click', ()=>{
      if($('pin-input').value===PIN_CODE){
        hideModal(pinModal);
        localStorage.removeItem(STORAGE);
        location.reload();
      }else{
        $('pin-error').classList.remove('hidden');
      }
    });

    /* =============== بدء التشغيل =============== */
    function init(){
      const ok = load();
      if(!ok){ resetState(); }
      if(ok && state.name){ updateHome(); show('home-screen'); }
      lucide.createIcons();
    }
    init();
  });
  </script>
</body>
</html>
