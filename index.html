<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <title>صديقي الذكي — مشروع مدرسي (مدرسة الإمارات الوطنية)</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts: Cairo -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet"/>

  <!-- Lucide Icons (CDN) -->
  <script src="https://unpkg.com/lucide@latest" defer></script>

  <style>
    /* CSS Variables & Core Styles 
      تم الحفاظ على الأنماط الأساسية لضمان التوافق مع جميع الأجهزة وسلوك العرض المطلوب.
    */
    :root {
      --vh: 1vh;
      --safeT: env(safe-area-inset-top, 0px);
      --safeB: env(safe-area-inset-bottom, 0px);
      --card-bg: rgba(248, 250, 252, .92);
      --footer-h: 0px;       /* يُملأ آليًا من JS */
      --chat-header-h: 56px; /* ارتفاع هيدر المحادثة */
      --chat-footer-h: 68px; /* ارتفاع فوتر المحادثة */
    }

    html, body {
      height: 100%; margin: 0; padding: 0;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      overscroll-behavior-y: none;
      scroll-behavior: smooth;
      background-color: #e2e8f0;
    }

    body {
      font-family: 'Cairo', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
      color: #0f172a;
      line-height: 1.9;
      -webkit-tap-highlight-color: transparent;
    }

    /* خلفية متجاوبة مع كل الشاشات */
    #app-wrapper {
      min-height: 100dvh;
      background-image:
        linear-gradient(rgba(245,248,252,.85), rgba(245,248,252,.88)),
        url('https://www.albayan.ae/assets/archives/images/2024/05/16/4873295.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    @supports not (height: 100dvh) {
      #app-wrapper { min-height: calc(var(--vh) * 100); }
    }

    /* الحاوية الرئيسية للتطبيق */
    #app-container {
      width: 100%;
      max-width: 28rem; /* md */
      min-height: 100dvh;
      margin-inline: auto;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
      isolation: isolate; /* لتجنب مشاكل z-index على iOS */
    }
    @supports not (height: 100dvh) {
      #app-container { min-height: calc(var(--vh) * 100); }
    }
    @media (min-width: 768px) { #app-container { max-width: 32rem; } }
    @media (orientation:landscape) { #app-container { max-width: 60rem; } }
    @media (min-width:1024px) { #app-container { max-width: 64rem; } }

    /* الشاشات والمودالات (تُعرض وتُخفى عبر JS) */
    .screen, .modal { display: none; }
    .screen.active, .modal.active { display: flex; }

    /* إعدادات المودال (النافذة المنبثقة) */
    .modal {
      position: fixed; inset: 0; z-index: 100;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(4px);
      align-items: center; justify-content: center; padding: 1rem;
    }
    .modal .sheet {
      background: #fff; width: 100%; max-width: 42rem;
      max-height: calc(100dvh - 2rem);
      border-radius: 1rem;
      box-shadow: 0 20px 50px rgba(0,0,0,.2);
      display: flex; flex-direction: column;
      overflow: hidden;
    }
    .modal .sheet > header {
      position: sticky; top: 0; z-index: 1; background: #fff;
      border-bottom: 1px solid rgb(226 232 240);
      padding: 1rem; display: flex; align-items: center; justify-content: space-between;
    }
    .modal .sheet .body {
      flex: 1 1 auto; overflow-y: auto;
      -webkit-overflow-scrolling: touch; padding: 1.5rem;
    }

    /* خلفية زجاجية للشاشات */
    .bg-screen { background: var(--card-bg); backdrop-filter: blur(4px); }

    /* التذييل الثابت */
    .app-footer {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 40;
      background: rgba(255,255,255,.92); backdrop-filter: blur(6px);
      border-top: 1px solid rgb(226 232 240);
      padding-bottom: max(8px, calc(var(--safeB) / 2));
    }

    /* إعدادات تمرير الشاشات */
    .screen {
      min-height: 0; flex: 1 1 auto; overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-top: max(0px, var(--safeT));
      padding-bottom: calc(var(--chat-footer-h) + var(--footer-h) + var(--safeB) + 24px);
    }
    #plan-review-screen #plan-content { padding-bottom: calc(var(--chat-footer-h) + var(--footer-h) + var(--safeB) + 64px); }
    #plan-review-screen .bg-white { overflow: visible; }

    /* هيدر وفوتر المحادثة الثابتين */
    #chat-screen > header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 50; background: #ffffff;
    }
    #chat-screen #chat-messages { padding-top: calc(var(--chat-header-h) + 8px); }
    #chat-screen #chat-footer {
      position: fixed; left: 0; right: 0; z-index: 49;
      bottom: calc(var(--footer-h));
      background: rgba(255,255,255,.9); backdrop-filter: blur(6px);
    }
    @media (orientation:landscape) { #chat-messages { padding-bottom:.25rem; } }


    /* تصميم فقاعات المحادثة */
    #chat-messages { display:flex; flex-direction:column; gap:.5rem; scroll-padding-bottom:160px; }
    #chat-messages .msg-row { display:flex; width:100%; }
    #chat-messages .msg-row.user { justify-content:flex-end; }
    #chat-messages .msg-row.bot { justify-content:flex-start; }
    #chat-messages .bubble {
      max-width:78%; border-radius:16px; padding:.6rem .8rem;
      position:relative; word-wrap:break-word;
      box-shadow:0 1px 0 rgba(0,0,0,.05); line-height:1.9;
    }
    #chat-messages .bubble-user { background:#dcf8c6; color:#0b141a; border:1px solid rgba(0,0,0,.06); border-top-right-radius:6px; }
    #chat-messages .bubble-user::after { content:""; position:absolute; bottom:.25rem; right:-6px; width:0; height:0; border:7px solid transparent; border-left-color:#dcf8c6; border-right:0; border-top:0; }
    #chat-messages .bubble-bot { background:#ffffff; color:#0b141a; border:1px solid rgba(0,0,0,.06); border-top-left-radius:6px; }
    #chat-messages .bubble-bot::after { content:""; position:absolute; bottom:.25rem; left:-6px; width:0; height:0; border:7px solid transparent; border-right-color:#ffffff; border-left:0; border-top:0; }
    #chat-messages .bubble-meta { display:flex; gap:.35rem; align-items:center; justify-content:flex-end; font-size:.72rem; opacity:.7; margin-top:.18rem; }
    .tick { font-weight:700; letter-spacing:-.02em; } .tick.dim { opacity:.55; }
    .day-sep { display:flex; align-items:center; justify-content:center; gap:.6rem; margin:.4rem 0; }
    .day-sep:before, .day-sep:after { content:""; flex:1; height:1px; background:rgba(15,23,42,.12); }
    .day-sep span { background:#eaf1f7; color:#0f172a; border:1px solid rgba(15,23,42,.06); padding:.15rem .6rem; border-radius:9999px; font-size:.75rem; }
    .chat-bubble { animation:pop .22s cubic-bezier(.2,.9,.3,1.4); }
    @keyframes pop { from{opacity:0; transform:scale(.96)} to{opacity:1; transform:scale(1)} }

    /* أنماط مساعدة */
    .age-btn.selected, .gender-btn.selected { border-color:#0ea5e9; background:#f0f9ff; color:#0284c7; }
    .button-disabled { background-color: #94a3b8 !important; cursor: not-allowed !important; }
    .badge { display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .6rem; border-radius:9999px; font-size:.75rem; }
    .brand-gradient { background:linear-gradient(135deg,#0ea5e9 0%,#14b8a6 100%); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .hit { min-height:44px; min-width:44px; }
  </style>
</head>
<body class="antialiased">
  <div id="app-wrapper">
    <div id="app-container" class="mx-auto shadow-lg">

      <!-- تم نقل محتوى الشاشات إلى هنا مباشرة بدلًا من حقنها بـ JS -->
      <main id="main" class="flex-1 relative flex flex-col" role="main" aria-label="المحتوى الرئيسي">
        
        <!-- شاشة البداية -->
        <section id="start-screen" class="screen bg-transparent flex-col items-center justify-center p-8 text-center" aria-label="البدء">
          <div class="w-full max-w-md bg-white/90 rounded-2xl shadow-lg p-6">
            <div class="w-20 h-20 rounded-full bg-sky-50 border border-sky-100 flex items-center justify-center mx-auto mb-3"><i data-lucide="bot" class="w-10 h-10 text-sky-600" aria-hidden="true"></i></div>
            <h1 class="text-3xl font-bold mb-2">صديقي الذكي</h1>
            <p class="text-slate-600 mb-6">مرشد رقمي آمن يساعد طفلك على تخطي التحديات الاجتماعية بخطوات قصيرة ومناسبة للعمر.</p>
            <button data-action="navigate" data-screen="intro-screen" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-8 rounded-full shadow-lg hit" aria-label="ابدأ">ابدأ</button>
          </div>
        </section>

        <!-- شاشة التعريف والالتزامات -->
        <section id="intro-screen" class="screen bg-screen flex-col items-stretch p-8" aria-label="التزامات">
          <i data-lucide="shield-check" class="w-16 h-16 text-sky-500 mx-auto mb-4" aria-hidden="true"></i>
          <h2 class="text-2xl font-bold text-center mb-2">كيف نعمل؟ والتزاماتنا</h2>
          <p class="text-slate-600 text-center mb-6">نبني علاقة ودّية أولًا، ثم نجمع بيانات تدريجيًا لكشف الاحتياجات الخفية، وبعدها ندرّب بخطوات متدرجة وآمنة.</p>
          <ul class="space-y-3 text-sm text-slate-700">
            <li class="flex items-start gap-3"><i data-lucide="scale" class="w-5 h-5 text-sky-500 mt-0.5 shrink-0" aria-hidden="true"></i><span><b>امتثال:</b> الالتزام بقوانين الإمارات والمعايير الدولية لسلامة الطفل.</span></li>
            <li class="flex items-start gap-3"><i data-lucide="database" class="w-5 h-5 text-sky-500 mt-0.5 shrink-0" aria-hidden="true"></i><span><b>خصوصية:</b> لا نطلب بيانات تعريفية؛ التخزين محلي؛ لا تُشارك المحادثات.</span></li>
            <li class="flex items-start gap-3"><i data-lucide="stethoscope" class="w-5 h-5 text-sky-500 mt-0.5 shrink-0" aria-hidden="true"></i><span><b>حدود:</b> إرشاد تربوي — ليس تشخيصاً طبياً/نفسياً. عند مؤشرات الخطر نوصي بالتصعيد لمختص مرخّص.</span></li>
            <li class="flex items-start gap-3"><i data-lucide="child" class="w-5 h-5 text-sky-500 mt-0.5 shrink-0" aria-hidden="true"></i><span><b>الهدف:</b> تمكين الطفل تدريجيًا عبر تمارين قابلة للقياس.</span></li>
          </ul>
          <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <button data-action="navigate" data-screen="start-screen" class="bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-full hover:bg-slate-300 hit" aria-label="رجوع">رجوع</button>
            <button data-action="navigate" data-screen="profile-setup-screen" class="bg-sky-600 text-white font-bold py-3 px-6 rounded-full hover:bg-sky-700 hit" aria-label="موافق">موافق</button>
          </div>
        </section>

        <!-- شاشة الملف الشخصي -->
        <section id="profile-setup-screen" class="screen bg-screen flex-col p-8" aria-label="ملف الطفل">
          <i data-lucide="user-round-check" class="w-16 h-16 text-sky-500 mx-auto mb-6" aria-hidden="true"></i>
          <h2 class="text-2xl font-bold text-center mb-2">ملف البطل الشخصي</h2>
          <div class="w-full space-y-6">
            <div>
                <label class="font-bold mb-2 block" for="child-name-input">اسم الطفل/الطفلة</label>
                <input id="child-name-input" type="text" class="w-full bg-white/90 border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-sky-400" placeholder="مثال: خالد أو علياء" aria-required="true">
            </div>
            <div>
              <p class="font-bold mb-2">الفئة العمرية</p>
              <div class="grid grid-cols-3 gap-3" role="group" aria-label="اختيار الفئة العمرية">
                <button data-age="3-7"  class="age-btn bg-white/90 border-2 border-slate-200 p-3 rounded-xl font-bold hit" aria-pressed="false">3–7</button>
                <button data-age="8-12" class="age-btn bg-white/90 border-2 border-slate-200 p-3 rounded-xl font-bold hit" aria-pressed="false">8–12</button>
                <button data-age="13-18" class="age-btn bg-white/90 border-2 border-slate-200 p-3 rounded-xl font-bold hit" aria-pressed="false">13–18</button>
              </div>
            </div>
            <div>
              <p class="font-bold mb-2">الجنس</p>
              <div class="grid grid-cols-2 gap-3" role="group" aria-label="اختيار الجنس">
                <button data-gender="ذكر"  class="gender-btn bg-white/90 border-2 border-slate-200 p-3 rounded-xl font-bold hit" aria-pressed="false">ذكر</button>
                <button data-gender="أنثى" class="gender-btn bg-white/90 border-2 border-slate-200 p-3 rounded-xl font-bold hit" aria-pressed="false">أنثى</button>
              </div>
            </div>
          </div>
          <div class="mt-8">
            <button id="continue-profile-btn" class="w-full bg-sky-600 text-white font-bold py-3 px-6 rounded-full text-lg shadow-lg hit" disabled aria-disabled="true">متابعة</button>
          </div>
        </section>

        <!-- شاشة إدخال وليّ الأمر -->
        <section id="parent-input-screen" class="screen bg-screen flex-col p-8" aria-label="رؤية وليّ الأمر">
          <i data-lucide="file-text" class="w-16 h-16 text-sky-500 mx-auto mb-6" aria-hidden="true"></i>
          <h2 class="text-2xl font-bold text-center mb-2">رؤية وليّ الأمر</h2>
          <p class="text-slate-600 text-center mb-6">كلما كانت التفاصيل أدق، كانت الخطة أفضل. لا نطلب بيانات تعريفية.</p>
          <div class="space-y-6">
            <div><label class="font-bold mb-2 block" for="child-personality">1) شخصية الطفل</label><textarea id="child-personality" rows="3" class="w-full bg-white/90 border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-sky-400" placeholder="مثال: مبدع، هادئ، حساس، حركي..." aria-required="true"></textarea></div>
            <div><label class="font-bold mb-2 block" for="child-challenges">2) أهم التحديات الاجتماعية</label><textarea id="child-challenges" rows="4" class="w-full bg-white/90 border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-sky-400" placeholder="مثال: صعوبة تكوين صداقات، خجل من المشاركة..." aria-required="true"></textarea></div>
          </div>
          <div class="mt-8">
            <button id="analyze-btn" class="w-full bg-sky-600 text-white font-bold py-3 px-6 rounded-full text-lg shadow-lg hover:bg-sky-700 hit" disabled aria-disabled="true">تحليل وإنشاء الخطة الأولية</button>
          </div>
        </section>

        <!-- شاشة مراجعة الخطة -->
        <section id="plan-review-screen" class="screen bg-screen flex-col p-8" aria-label="مراجعة الخطة">
          <div id="loading-spinner" class="m-auto text-center items-center justify-center flex flex-col" aria-live="polite">
            <i data-lucide="loader-circle" class="w-16 h-16 text-sky-500 mx-auto mb-4 animate-spin" aria-hidden="true"></i>
            <h3 class="text-xl font-bold">إنشاء خطة أولية دقيقة...</h3>
            <p class="text-slate-500">يستغرق لحظات.</p>
          </div>
          <div id="plan-content" class="hidden flex-col">
            <i data-lucide="clipboard-check" class="w-16 h-16 text-green-500 mx-auto mb-6" aria-hidden="true"></i>
            <h2 class="text-2xl font-bold text-center mb-2">الخطة المقترحة (للمراجعة)</h2>
            <p class="text-slate-600 text-center mb-6">اختر: <b>موافقة</b> أو <b>طلب تعديل</b>. عند التعديل نجمع الأسباب ونولّد خطة جديدة.</p>
            <div class="bg-white border border-slate-200 rounded-xl p-4 space-y-4">
              <div><h4 class="font-bold flex items-center gap-2"><i data-lucide="user-round-cog" class="w-5 h-5 text-sky-600" aria-hidden="true"></i>ملخص التحليل</h4><p id="ai-analysis-summary" class="text-slate-700 mt-1"></p></div>
              <div><h4 class="font-bold flex items-center gap-2"><i data-lucide="target" class="w-5 h-5 text-sky-600" aria-hidden="true"></i>فرضية الاحتياجات</h4><ul id="ai-needs-hypo" class="list-disc list-inside mt-2 space-y-1 text-slate-700"></ul></div>
              <div><h4 class="font-bold flex items-center gap-2"><i data-lucide="list-checks" class="w-5 h-5 text-sky-600" aria-hidden="true"></i>خطوات التدريب</h4><ul id="ai-plan-steps" class="list-decimal list-inside mt-2 space-y-1 text-slate-700"></ul></div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-6">
              <button id="approve-plan-btn" class="w-full bg-emerald-600 text-white font-bold py-3 px-6 rounded-full shadow hover:bg-emerald-700 hit" aria-label="موافقة على الخطة">موافقة على الخطة</button>
              <button data-action="navigate" data-screen="plan-change-screen" class="w-full bg-amber-500 text-white font-bold py-3 px-6 rounded-full shadow hover:bg-amber-600 hit" aria-label="طلب تعديل">طلب تعديل</button>
            </div>
          </div>
        </section>

        <!-- شاشة أسباب التعديل -->
        <section id="plan-change-screen" class="screen bg-screen flex-col p-8" aria-label="أسباب التعديل">
          <i data-lucide="edit" class="w-16 h-16 text-sky-500 mx-auto mb-6" aria-hidden="true"></i>
          <h2 class="text-2xl font-bold text-center mb-2">أسباب التعديل</h2>
          <textarea id="plan-change-reason" rows="6" class="w-full bg-white/90 border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-sky-400" placeholder="اذكر الأسباب المحددة: صعوبة خطوة، مواقف واقعية، أهداف جديدة، حساسية ثقافية/مدرسية..."></textarea>
          <div class="mt-6"><button id="re-analyze-btn" class="w-full bg-sky-600 text-white font-bold py-3 px-6 rounded-full text-lg shadow hover:bg-sky-700 hit" aria-label="إعادة التحليل">إعادة التحليل وإنتاج خطة جديدة</button></div>
        </section>

        <!-- شاشة الصفحة الرئيسية -->
        <section id="home-screen" class="screen bg-transparent flex-col p-6" aria-label="الصفحة الرئيسية">
          <header class="flex justify-between items-center mb-6">
            <div><p id="home-greeting" class="text-slate-500"></p><h2 id="home-mission-status" class="text-2xl font-bold">جاهز لمغامرة اليوم؟</h2></div>
            <div class="flex items-center gap-2">
              <button data-action="open-modal" data-modal="parent-modal" class="p-2 rounded-full bg-white/60 hover:bg-sky-100 text-sky-600 hit" title="لوحة وليّ الأمر" aria-label="لوحة وليّ الأمر"><i data-lucide="file-lock" class="w-5 h-5"></i></button>
              <button data-action="open-modal" data-modal="pin-modal" class="p-2 rounded-full bg-white/60 hover:bg-red-100 text-red-500 hit" title="حذف المحادثة" aria-label="حذف المحادثة"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
            </div>
          </header>
          <main class="flex-grow flex flex-col justify-center items-center text-center">
            <div class="w-44 h-44 md:w-48 md:h-48 bg-white/60 backdrop-blur-sm rounded-full flex items-center justify-center mb-6"><i data-lucide="bot" class="w-24 h-24 md:w-28 md:h-28 text-sky-600" aria-hidden="true"></i></div>
            <h3 id="home-ai-name-intro" class="text-2xl font-bold mb-2"></h3>
            <p id="home-intro-text" class="text-slate-500 max-w-xs mb-6"></p>
            <button id="initiate-chat-btn" class="w-full bg-sky-600 text-white font-bold py-4 px-6 rounded-full text-lg shadow flex items-center justify-center gap-2 hit" aria-label="ابدأ الدردشة"><i data-lucide="message-circle"></i><span id="start-chat-btn-text"></span></button>
          </main>
        </section>
        
        <!-- شاشة المحادثة -->
        <section id="chat-screen" class="screen bg-screen flex-col" aria-label="المحادثة">
          <header class="bg-white p-4 flex items-center gap-4 border-b border-slate-200">
            <button data-action="navigate" data-screen="home-screen" class="p-2 rounded-full hover:bg-slate-100 hit" aria-label="إنهاء الدردشة"><i data-lucide="arrow-right"></i></button>
            <div class="w-10 h-10 bg-gradient-to-br from-cyan-100 to-sky-200 rounded-full flex items-center justify-center shrink-0"><i data-lucide="bot" class="w-6 h-6 text-sky-600" aria-hidden="true"></i></div>
            <div class="flex-grow"><h3 id="chat-header-name" class="font-bold"></h3><p class="text-xs text-green-500 font-medium flex items-center gap-1"><span class="w-2 h-2 bg-green-400 rounded-full"></span>متصل</p></div>
            <button data-action="open-modal" data-modal="parent-modal" class="p-2 rounded-full hover:bg-slate-100 text-slate-600 hit" title="لوحة وليّ الأمر" aria-label="لوحة وليّ الأمر"><i data-lucide="file-lock" class="w-5 h-5"></i></button>
            <button id="language-toggle-btn" class="p-2 rounded-full hover:bg-slate-100 text-slate-600 hit" title="تبديل اللغة"><i data-lucide="languages" class="w-5 h-5"></i></button>
          </header>
          <main id="chat-messages" class="flex-grow p-4 overflow-y-auto" aria-live="polite"></main>
          <footer id="chat-footer" class="p-4 border-t border-slate-200">
            <p id="free-text-hint" class="text-[12px] text-slate-500 mb-2 hidden"></p>
            <div id="chat-options-container" class="mb-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2" role="listbox" aria-label="مقترحات الرد"></div>
            <form id="chat-form" class="flex items-center gap-2" aria-label="إرسال رسالة">
              <input id="chat-input" type="text" placeholder="اكتب ردك هنا..." class="w-full bg-white border-2 border-slate-200 rounded-full py-2 px-4 focus:outline-none focus:border-sky-400" autocomplete="off" aria-label="حقل كتابة الرسالة"/>
              <button type="submit" class="bg-sky-600 text-white rounded-full p-3 hover:bg-sky-700 hit" aria-label="إرسال"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
            </form>
          </footer>
        </section>

      </main>

      <!-- التذييل الثابت -->
      <footer id="app-footer" class="app-footer w-full shrink-0" role="contentinfo" aria-label="تذييل">
        <div class="px-3 py-2 text-[11px] sm:text-xs flex flex-col sm:flex-row items-center justify-between gap-2">
          <div class="flex items-center gap-2" aria-label="شعارات الأمان">
            <span class="badge bg-cyan-100 text-cyan-700 font-semibold"><i data-lucide="shield-check" class="w-3.5 h-3.5" aria-hidden="true"></i> أمان الطفل أولاً</span>
            <span class="badge bg-emerald-100 text-emerald-700 font-semibold"><i data-lucide="sprout" class="w-3.5 h-3.5" aria-hidden="true"></i> توجيه تربوي إيجابي</span>
          </div>
          <div class="text-center leading-tight">
            <div class="font-bold brand-gradient">© صديقي الذكي — مشروع مدرسي</div>
            <div class="text-slate-500">مدرسة الإمارات الوطنية — حقوق الطالب: <span class="font-bold">يوسف سالمين</span></div>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <!-- مودال الحذف / رمز الحماية العام -->
  <div id="pin-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="pin-title">
    <div class="sheet w-full max-w-sm">
      <header class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i data-lucide="shield-alert" class="w-5 h-5 text-amber-600" aria-hidden="true"></i>
          <h3 id="pin-title" class="text-lg font-bold">تأكيد العملية</h3>
        </div>
        <button class="p-2 rounded-full hover:bg-slate-100 hit" aria-label="إغلاق" data-action="close-modal" data-modal="pin-modal"><i data-lucide="x"></i></button>
      </header>
      <div class="body">
        <p id="pin-purpose-text" class="text-slate-600 text-sm mb-4">أدخل رمز الحماية (2222) للمتابعة.</p>
        <input id="pin-input" type="tel" inputmode="numeric" maxlength="4" placeholder="••••" class="w-full text-center tracking-[1em] bg-slate-100 border-2 border-slate-200 rounded-xl p-3 text-2xl focus:outline-none focus:border-sky-400" aria-label="إدخال رمز الحماية">
        <p id="pin-error" class="text-red-500 text-xs mt-2 hidden" role="alert">رمز غير صحيح</p>
        <p id="pin-lock-msg" class="text-amber-600 text-xs mt-2 hidden" role="alert"></p>
        <div class="grid grid-cols-2 gap-3 mt-5">
          <button data-action="close-modal" data-modal="pin-modal" class="bg-slate-200 text-slate-800 font-bold py-2 rounded-full hit" aria-label="إلغاء">إلغاء</button>
          <button id="pin-ok" class="bg-red-500 text-white font-bold py-2 rounded-full hit" aria-label="تأكيد">تأكيد</button>
        </div>
      </div>
    </div>
  </div>

  <!-- مودال لوحة وليّ الأمر -->
  <div id="parent-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="parent-title">
    <div class="sheet w-full">
      <header>
        <div class="flex items-center gap-2"><i data-lucide="layout-dashboard" class="w-5 h-5 text-sky-600" aria-hidden="true"></i><h3 id="parent-title" class="text-lg font-bold">لوحة وليّ الأمر</h3></div>
        <button data-action="close-modal" data-modal="parent-modal" class="p-2 rounded-full hover:bg-slate-100 hit" aria-label="إغلاق اللوحة"><i data-lucide="x"></i></button>
      </header>
      <div class="body">
        <div id="parent-auth" class="">
          <p class="text-slate-600 mb-3">أدخل الرمز (2222) للوصول:</p>
          <div class="flex items-center gap-3">
            <input id="parent-pin" type="tel" inputmode="numeric" maxlength="4" placeholder="••••" class="flex-1 text-center tracking-[1em] bg-slate-100 border-2 border-slate-200 rounded-xl p-3 text-2xl focus:outline-none focus:border-sky-400" aria-label="رمز وليّ الأمر">
            <button id="parent-unlock" class="bg-sky-600 text-white font-bold py-2 px-6 rounded-full hit" aria-label="فتح اللوحة">فتح</button>
          </div>
          <p id="parent-auth-error" class="text-red-500 text-xs mt-2 hidden" role="alert">رمز غير صحيح</p>
          <p id="parent-lock-msg" class="text-amber-600 text-xs mt-2 hidden" role="alert"></p>
        </div>

        <div id="parent-dashboard" class="hidden space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="bg-slate-50 border border-slate-200 rounded-xl p-3"><div class="text-xs text-slate-500">اسم الطفل</div><div id="pd-name" class="font-bold"></div></div>
            <div class="bg-slate-50 border border-slate-200 rounded-xl p-3"><div class="text-xs text-slate-500">نتيجة المؤشّر</div><div id="pd-level" class="font-bold"></div></div>
            <div class="bg-slate-50 border border-slate-200 rounded-xl p-3"><div class="text-xs text-slate-500">الخطوة الجارية</div><div id="pd-step" class="font-bold"></div></div>
          </div>
          <div class="bg-white border border-slate-200 rounded-xl p-4">
            <h4 class="font-bold flex items-center gap-2"><i data-lucide="user-round-cog" class="w-5 h-5 text-sky-600" aria-hidden="true"></i>ملخص الشخصيّة والتحديات</h4>
            <p id="pd-summary" class="text-slate-700 mt-2"></p>
          </div>
          <div class="bg-white border border-slate-200 rounded-xl p-4">
            <h4 class="font-bold flex items-center gap-2 mb-2"><i data-lucide="sparkles" class="w-5 h-5 text-sky-600" aria-hidden="true"></i>توصيات الذكاء الاصطناعي (محدّثة)</h4>
            <ul id="pd-recos" class="list-disc list-inside space-y-1 text-slate-700"></ul>
            <div class="mt-3 flex items-center gap-2">
              <button id="pd-refresh" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-full hit" aria-label="تحديث الآن">تحديث الآن</button>
              <span id="pd-updated" class="text-xs text-slate-500" aria-live="polite"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    
    // =================================================================
    //  Module: App Core - الوحدة الأساسية للتطبيق
    //  Handles initialization, state, and constants.
    // =================================================================
    const App = {
      
      // --- Configuration ---
      config: {
        STORAGE_KEY: 'sadiki-ai-v31-refactored',
        PIN_CODE: '2222',
        MAX_PIN_ATTEMPTS: 5,
        LOCKOUT_DURATION_MS: 5 * 60 * 1000, // 5 minutes
      },

      // --- Application State ---
      state: {},

      // --- DOM Element Cache ---
      dom: {},

      // --- Initialization ---
      init() {
        // Cache all frequently used DOM elements
        this.cacheDomElements();
        
        // Load state from localStorage or set defaults
        this.loadState();
        
        // Bind all event listeners
        this.bindEventListeners();

        // Setup dynamic UI elements like viewport height
        this.setupUI();

        // Determine the initial screen to show
        if (this.state.name) {
          this.ui.updateHomeScreen();
          this.ui.showScreen('home-screen');
        } else {
          this.ui.showScreen('start-screen');
        }

        console.log("صديقي الذكي: التطبيق جاهز.");
      },

      // --- State Management ---
      loadState() {
        try {
          const storedState = localStorage.getItem(this.config.STORAGE_KEY);
          if (storedState) {
            this.state = JSON.parse(storedState);
            return;
          }
        } catch (e) {
          console.error("Failed to load state:", e);
        }
        this.resetState();
      },

      saveState() {
        try {
          localStorage.setItem(this.config.STORAGE_KEY, JSON.stringify(this.state));
        } catch (e) {
          console.error("Failed to save state:", e);
        }
      },

      resetState() {
        this.state = {
          language: 'ar', age: null, gender: null, name: null, aiName: null,
          parentDesc: null, plan: null, chat: [], step: 0, assessment: null,
          askedQuestions: [], lastDateKey: null, parentSummary: null, parentSummaryAt: null,
          parentReport: { text: '', at: 0 }
        };
        this.saveState();
      },

      // --- DOM Caching ---
      cacheDomElements() {
        const ids = [
            'main', 'app-footer',
            // Profile Setup
            'child-name-input', 'continue-profile-btn',
            // Parent Input
            'child-personality', 'child-challenges', 'analyze-btn',
            // Plan Review
            'loading-spinner', 'plan-content', 'ai-analysis-summary', 'ai-needs-hypo', 'ai-plan-steps',
            'approve-plan-btn', 'plan-change-reason', 're-analyze-btn',
            // Home Screen
            'home-greeting', 'home-ai-name-intro', 'home-intro-text', 'home-mission-status', 'initiate-chat-btn', 'start-chat-btn-text',
            // Chat Screen
            'chat-header-name', 'chat-messages', 'chat-footer', 'free-text-hint', 'chat-options-container', 'chat-form', 'chat-input', 'language-toggle-btn',
            // PIN Modal
            'pin-modal', 'pin-input', 'pin-error', 'pin-lock-msg', 'pin-ok',
            // Parent Modal
            'parent-modal', 'parent-auth', 'parent-dashboard', 'parent-pin', 'parent-unlock',
            'parent-auth-error', 'parent-lock-msg', 'pd-name', 'pd-level', 'pd-step',
            'pd-summary', 'pd-recos', 'pd-updated', 'pd-refresh'
        ];
        ids.forEach(id => this.dom[id] = document.getElementById(id));
        this.dom.ageBtns = [...document.querySelectorAll('.age-btn')];
        this.dom.genderBtns = [...document.querySelectorAll('.gender-btn')];
      },

      // --- UI Setup ---
      setupUI() {
        if (window.lucide) { lucide.createIcons(); }

        // Responsive viewport height
        const setVH = () => document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
        setVH();
        window.addEventListener('resize', setVH);

        // Dynamic footer/header heights for CSS layout
        const setCssVars = () => {
          document.documentElement.style.setProperty('--footer-h', `${this.dom['app-footer']?.offsetHeight || 0}px`);
          const chatHeader = document.querySelector('#chat-screen > header');
          document.documentElement.style.setProperty('--chat-header-h', `${chatHeader?.offsetHeight || 56}px`);
          document.documentElement.style.setProperty('--chat-footer-h', `${this.dom['chat-footer']?.offsetHeight || 68}px`);
        };
        
        setCssVars();
        new ResizeObserver(setCssVars).observe(this.dom['app-footer']);
        const chatHeader = document.querySelector('#chat-screen > header');
        if (chatHeader) new ResizeObserver(setCssVars).observe(chatHeader);
        if (this.dom['chat-footer']) new ResizeObserver(setCssVars).observe(this.dom['chat-footer']);
      },

    };

    // =================================================================
    //  Module: UI - وحدة الواجهة الرسومية
    //  Handles all DOM manipulations, screen transitions, and UI updates.
    // =================================================================
    App.ui = {
      _app: App,

      showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.toggle('active', s.id === screenId));
        if (screenId === 'home-screen') {
            this.updateHomeScreen();
        }
      },

      showModal(modalId) {
        document.getElementById(modalId)?.classList.add('active');
      },

      hideModal(modalId) {
        document.getElementById(modalId)?.classList.remove('active');
      },
      
      toggleButtonState(button, enabled) {
        button.disabled = !enabled;
        button.setAttribute('aria-disabled', String(!enabled));
        button.classList.toggle('button-disabled', !enabled);
      },

      addChatMessage(text, role = 'model', ts = Date.now()) {
        const safeText = App.utils.stripPII(text || '');
        this._insertDaySeparatorIfNeeded(ts);

        const row = document.createElement('div');
        row.className = `msg-row ${role === 'user' ? 'user' : 'bot'}`;
        row.setAttribute('role', 'article');
        row.setAttribute('aria-label', role === 'user' ? 'رسالة الطفل' : 'رسالة الذكاء');

        const bubbleWrap = document.createElement('div');
        bubbleWrap.className = `chat-bubble bubble ${role === 'user' ? 'bubble-user' : 'bubble-bot'}`;
        
        const content = document.createElement('div');
        content.textContent = safeText;
        bubbleWrap.appendChild(content);

        const meta = document.createElement('div');
        meta.className = 'bubble-meta';
        meta.innerHTML = `<span>${App.utils.formatTime(ts)}</span>` + 
                         (role === 'user' ? '<span class="tick dim">✓</span>' : '');
        bubbleWrap.appendChild(meta);
        
        row.appendChild(bubbleWrap);
        this._app.dom['chat-messages'].appendChild(row);

        setTimeout(() => {
          this._app.dom['chat-messages'].scrollTop = this._app.dom['chat-messages'].scrollHeight;
          bubbleWrap.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }, 50);
      },

      _insertDaySeparatorIfNeeded(ts) {
        const { key, label } = App.utils.getDateLabel(ts);
        if (this._app.state.lastDateKey !== key) {
          const sep = document.createElement('div');
          sep.className = 'day-sep';
          sep.innerHTML = `<span>${label}</span>`;
          this._app.dom['chat-messages'].appendChild(sep);
          this._app.state.lastDateKey = key;
          this._app.saveState();
        }
      },
      
      showTypingIndicator() {
        this._insertDaySeparatorIfNeeded(Date.now());
        const indicatorHTML = `<div id="typing-indicator" class="msg-row bot"><div class="chat-bubble bubble bubble-bot" aria-label="يكتب الآن"><span class="inline-block w-2 h-2 bg-slate-500 rounded-full animate-pulse"></span></div></div>`;
        this._app.dom['chat-messages'].insertAdjacentHTML('beforeend', indicatorHTML);
        this._app.dom['chat-messages'].scrollTop = this._app.dom['chat-messages'].scrollHeight;
      },

      hideTypingIndicator() {
        document.getElementById('typing-indicator')?.remove();
      },

      renderChatOptions(options = []) {
        const container = this._app.dom['chat-options-container'];
        container.innerHTML = '';

        if (options.length === 0) {
            this._app.dom['free-text-hint'].classList.add('hidden');
            return;
        }

        this._app.dom['free-text-hint'].textContent = 'يمكنك الضغط على مقترح أو كتابة شعورك بحرّية.';
        this._app.dom['free-text-hint'].classList.remove('hidden');

        options.forEach(opt => {
          const btn = document.createElement('button');
          btn.className = 'w-full text-sky-700 bg-sky-100 font-medium py-2 px-3 rounded-lg hover:bg-sky-200 text-sm hit';
          btn.setAttribute('role', 'option');
          btn.textContent = opt;
          btn.addEventListener('click', () => App.handlers.handleUserMessage(opt));
          container.appendChild(btn);
        });

        // "Something else" button
        const otherBtn = document.createElement('button');
        otherBtn.className = 'w-full bg-white border border-slate-300 font-medium py-2 px-3 rounded-lg hover:bg-slate-100 text-sm hit';
        otherBtn.setAttribute('role', 'option');
        otherBtn.textContent = (this._app.state.language === 'ar') ? 'شيء آخر — سأكتب ردي' : "Something else — I'll type";
        otherBtn.addEventListener('click', () => this._app.dom['chat-input'].focus());
        container.appendChild(otherBtn);
      },

      renderPlan(plan) {
        this._app.dom['ai-analysis-summary'].textContent = plan.analysisSummary || '—';
        
        const renderList = (element, items) => {
            element.innerHTML = '';
            (items.length ? items : ['—']).forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                element.appendChild(li);
            });
        };

        renderList(this._app.dom['ai-needs-hypo'], plan.needsHypothesis || []);
        renderList(this._app.dom['ai-plan-steps'], plan.planSteps || []);

        this._app.dom['loading-spinner'].style.display = 'none';
        this._app.dom['plan-content'].classList.remove('hidden');
      },
      
      showPlanError() {
          this._app.dom['loading-spinner'].style.display = 'none';
          const planReviewScreen = document.getElementById('plan-review-screen');
          planReviewScreen.innerHTML = `
            <div class="m-auto flex flex-col items-center justify-center text-center gap-3 py-12">
              <i data-lucide="wifi-off" class="w-16 h-16 text-amber-500" aria-hidden="true"></i>
              <h3 class="text-xl font-bold">تعذّر إنشاء الخطة الآن</h3>
              <p class="text-slate-500 text-sm">تحقّق من الاتصال ثم جرّب مجددًا.</p>
              <button id="retry-plan" class="bg-sky-600 text-white font-bold py-3 px-6 rounded-full hover:bg-sky-700 hit" aria-label="إعادة المحاولة">إعادة المحاولة</button>
            </div>`;
          if (window.lucide) lucide.createIcons();
          document.getElementById('retry-plan').addEventListener('click', () => App.ai.generatePlan());
      },
      
      updateHomeScreen() {
        const S = this._app.state;
        const T = {
          ar:{g:`مرحباً يا ${S.name||''}`,m:`هدفنا:`,ready:`جاهز لمغامرة اليوم؟`,ai:`أنا ${S.aiName||'صديقك'}`,desc:{'ذكر':'رفيق رقمي يساعدك خطوة بخطوة.','أنثى':'رفيقة رقمية تساعدك خطوة بخطوة.'},chat:`ابدأ الدردشة مع ${S.aiName||'صديقي الذكي'}`,ph:'اكتب ردك هنا...'},
          en:{g:`Welcome, ${S.name||''}`,m:`Our goal:`,ready:`Ready for today’s adventure?`,ai:`I'm ${S.aiName||'your buddy'}`,desc:{'ذكر':'Your digital buddy to help you step by step.','أنثى':'Your digital buddy to help you step by step.'},chat:`Start chat with ${S.aiName||'Sadiki'}`,ph:'Type your reply here...'}
        };
        const L = T[S.language || 'ar'];
        
        this._app.dom['home-greeting'].textContent = L.g;
        this._app.dom['home-ai-name-intro'].textContent = L.ai;
        this._app.dom['home-intro-text'].textContent = L.desc[S.gender || 'ذكر'];
        this._app.dom['start-chat-btn-text'].textContent = L.chat;
        this._app.dom['chat-input'].placeholder = L.ph;
        this._app.dom['home-mission-status'].textContent = (S.plan?.planSteps?.[S.step]) ? `${L.m} ${S.plan.planSteps[S.step]}` : L.ready;
        this._app.dom['chat-header-name'].textContent = S.aiName || 'صديقي الذكي';
      },

      fillParentDashboard() {
        const S = this._app.state;
        this._app.dom['pd-name'].textContent = S.name || '—';
        this._app.dom['pd-step'].textContent = S.plan?.planSteps?.[S.step] || '—';
        this._app.dom['pd-level'].textContent = S.assessment?.result?.level || '—';
        this._app.dom['pd-summary'].textContent = S.plan?.analysisSummary || (S.parentDesc || '—');
        
        this._app.dom['pd-updated'].textContent = '';
        this._app.dom['pd-recos'].innerHTML = '';
        
        this.renderParentRecommendations();
      },

      renderParentRecommendations() {
        const recos = App.ai.buildParentRecommendations();
        const listEl = this._app.dom['pd-recos'];
        listEl.innerHTML = '';
        recos.forEach(txt => {
            const li = document.createElement('li');
            li.textContent = txt;
            listEl.appendChild(li);
        });

        const d = new Date();
        this._app.dom['pd-updated'].textContent = `آخر تحديث: ${d.toLocaleDateString('ar-AE')} ${d.toLocaleTimeString('ar-AE', {hour:'2-digit', minute:'2-digit'})}`;
      }
    };

    // =================================================================
    //  Module: AI Interface - وحدة توجيه الذكاء الاصطناعي
    //  Handles all interactions with the AI model, including prompt generation.
    // =================================================================
    App.ai = {
      _app: App,
      
      // --- AI Prompting Section ---
      // هذا الجزء مخصص لتوجيه الذكاء الاصطناعي بدقة
      prompts: {
        // سياسة الامتثال والمعايير العامة التي تضاف لكل طلب
        UAE_COMPLIANCE: `
          - الامتثال لاتفاقية حقوق الطفل وقانون وديمة في الإمارات.
          - إرشاد تربوي/سلوكي فقط؛ لا تشخيص أو دواء أو جمع بيانات تعريفية.
          - لغة مناسبة للعمر والثقافة؛ التوقف الآمن عند مؤشرات الخطر.
        `,

        // موجه خاص لإنشاء الخطة الأولية
        getPlanPrompt(parentDescription) {
          return `
            ${this.UAE_COMPLIANCE}
            حلّل وصف وليّ الأمر التالي بدقة، وسلّم الإجابة على هيئة JSON باللغة العربية فقط، دون أي مقدمات أو تعليقات أو علامات markdown.
            
            الهيكل المطلوب بدقة:
            {
             "analysisSummary": "جملة واحدة موجزة تلخص العلاقة بين سلوك الطفل، المحفزات المحتملة، والنتيجة (بحد أقصى 240 حرف).",
             "needsHypothesis": ["قائمة من 3 نقاط تحدد المهارات أو الاحتياجات الأساسية للطفل بوضوح."],
             "planSteps": ["قائمة من 3 إلى 5 خطوات تدريبية محددة، قابلة للقياس، يمكن تحقيقها، ذات صلة، ومحددة بوقت (SMART)."],
             "initialAssessment": {
               "intro": "نص ترحيبي قصير ومحفز لبدء التقييم.",
               "items": [
                 {"type":"choice", "q":"سؤال بسيط عن شعور أو سلوك شائع.", "options":["٣-٤ خيارات واضحة"]},
                 {"type":"selfCheck", "q":"سؤال لتقييم ذاتي على مقياس من 0 إلى 10.", "scaleMin":0, "scaleMax":10}
               ],
               "scoring": "شرح بسيط لكيفية تحويل الإجابات إلى مستوى (منخفض/متوسط/مرتفع)."
             }
            }

            مدخلات ولي الأمر: """${parentDescription}"""
          `;
        },

        // موجه خاص بالمحادثة مع الطفل
        getChatPrompt(lastUserMessage) {
          const S = App.state;
          return `
            ${this.UAE_COMPLIANCE}
            ---
            تعليمات صارمة (لا تظهرها للطفل):
            دورك: أنت مرشد سلوكي رقمي اسمه "${S.aiName}". مهمتك هي بناء علاقة ودية مع الطفل "${S.name}" وتوجيهه بخطوات صغيرة وعملية.
            
            قالب الرد الإلزامي:
            1.  ابدأ بتحية بسيطة ومباشرة باسم الطفل (مثال: "أهلاً يا ${S.name}").
            2.  اعكس شعور/سلوك الطفل بشكل محايد (مثال: "أسمع أنك تشعر بـ..." أو "يبدو أن الموقف كان...").
            3.  قدم معلومة عملية واحدة فقط، أو تمرينًا صغيرًا يمكن تطبيقه الآن.
            4.  اطرح سؤالًا واحدًا فقط ومفتوحًا لاستكشاف المزيد.
            5.  إذا كان السؤال يتطلب خيارات، قدم 3-4 خيارات مقترحة، كل منها في سطر يبدأ بـ "- ".
            6.  أضف السطر التالي دائمًا في نهاية الرد إذا قدمت خيارات: "إن لم يناسبك أي مقترح، اكتب شعورك بطريقتك."

            محاذير:
            - تجنب المديح المبالغ فيه ("أنت رائع!"). استخدم تشجيعًا محددًا ("محاولتك جيدة.").
            - لا تطرح أسئلة متعددة في رسالة واحدة.
            - لا تقدم نصائح طبية، قانونية، أو تجمع بيانات شخصية.
            - حافظ على الردود قصيرة ومناسبة للفئة العمرية (${S.age}).

            سياق المحادثة: "${lastUserMessage}".
            بيانات الطفل: الاسم="${S.name}", الفئة العمرية=${S.age}, الجنس=${S.gender}.
          `;
        }
      },

      // --- AI API Call ---
      async callProxy({ system, messages, mode = 'chat', forceLang = 'ar' }) {
          const body = {
            system,
            messages: messages.map(m => ({ role: m.role, content: m.content })),
            model: "auto", mode, force_lang: forceLang,
            guard_level: "strict", stream: false, timeout_ms: 28000
          };
          
          for (let attempt = 0; attempt <= 2; attempt++) {
            try {
              const response = await fetch('/.netlify/functions/gemini-proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
              });
              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
              return response.json();
            } catch (error) {
              if (attempt >= 2) throw error;
              await new Promise(res => setTimeout(res, 700 * (2 ** attempt)));
            }
          }
      },
      
      async generatePlan(isModification = false) {
        let parentDesc = '';
        if (isModification) {
            const reason = App.utils.stripPII(App.dom['plan-change-reason'].value.trim());
            if (reason.length < 10) { App.dom['plan-change-reason'].focus(); return; }
            parentDesc = `${App.state.parentDesc || ''} | أسباب التعديل: ${reason}`;
        } else {
            const p = App.utils.stripPII(App.dom['child-personality'].value.trim());
            const c = App.utils.stripPII(App.dom['child-challenges'].value.trim());
            parentDesc = `الشخصية: ${p} | التحديات: ${c}`;
            this._app.state.parentDesc = parentDesc;
        }

        App.ui.showScreen('plan-review-screen');
        App.dom['loading-spinner'].style.display = 'flex';
        App.dom['plan-content'].classList.add('hidden');

        try {
            const systemPrompt = this.prompts.getPlanPrompt(parentDesc);
            const { text } = await this.callProxy({
                system: systemPrompt,
                messages: [{ role: 'user', content: 'أعد الخطة وفق الهيكل المحدد فقط.' }],
                mode: 'plan',
            });
            
            const rawJson = (text || '').replace(/```json|```/gi, '').trim();
            const plan = this._validatePlanSchema(JSON.parse(rawJson));
            
            this._app.state.plan = plan;
            this._app.state.assessment = { spec: plan.initialAssessment || null, result: null, answers: [] };
            this._app.saveState();
            App.ui.renderPlan(plan);
        } catch (e) {
            console.error("Failed to generate plan:", e);
            App.ui.showPlanError();
        }
      },
      
      _validatePlanSchema(plan) {
        // Basic schema validation and cleaning
        const fixed = { analysisSummary:'', needsHypothesis:[], planSteps:[], initialAssessment:null, ...plan };
        fixed.analysisSummary = String(fixed.analysisSummary||'').trim().slice(0, 240);
        fixed.needsHypothesis = Array.isArray(fixed.needsHypothesis) ? fixed.needsHypothesis.filter(Boolean).slice(0, 5) : [];
        fixed.planSteps = Array.isArray(fixed.planSteps) ? fixed.planSteps.filter(Boolean).slice(0, 5) : [];
        // Add more robust validation if needed
        return fixed;
      },

      async getChatResponse(isFirstMessage = false) {
          App.ui.showTypingIndicator();
          try {
              const lastUserMsg = isFirstMessage ? '' : [...this._app.state.chat].reverse().find(m => m.role === 'user')?.parts[0].text || '';
              const systemPrompt = this.prompts.getChatPrompt(lastUserMsg);
              
              const history = isFirstMessage
                  ? [{ role: 'user', content: `ابدأ بتحية بسيطة لـ"${this._app.state.name}"، وقدم تمرينًا صغيرًا أو سؤالًا واحدًا فقط.` }]
                  : this._app.state.chat.map(m => ({ role: m.role, content: m.parts[0].text }));

              const { text } = await this.callProxy({
                  system: systemPrompt,
                  messages: history,
                  forceLang: this._app.state.language,
              });
              
              const fullResponse = text || '';
              const [mainText, ..._] = fullResponse.split(/\n\n/); // Take first paragraph as main message
              const options = this._extractOptions(fullResponse, mainText);
              
              App.ui.hideTypingIndicator();
              App.handlers.pushMessageToChat(mainText, 'model');
              App.ui.renderChatOptions(options);

          } catch (e) {
              console.error("AI response error:", e);
              App.ui.hideTypingIndicator();
              App.ui.addChatMessage('توقف مؤقت في الاتصال. اضغط مقترحًا أو اكتب للمتابعة.', 'model');
          }
      },
      
      _extractOptions(fullText, questionCtx) {
        const lines = fullText.split('\n').map(s => s.trim());
        const options = lines
          .map(line => line.replace(/^(-|\u2022)\s+/, '').trim())
          .filter(line => /^(-|\u2022)\s+/.test(fullText.split('\n').find(l => l.includes(line)) || '')) // Ensure it was a bullet point
          .filter(opt => /^\p{L}/u.test(opt) && opt.length <= 40);

        if (!/[\؟?]/.test(questionCtx || '')) return []; // Only show options if there is a question
        
        return [...new Set(options)].slice(0, 4); // Unique options, max 4
      },

      buildParentRecommendations() {
        const S = this._app.state;
        if (!S.plan) return ['لم يتم إنشاء خطة بعد.'];

        const recos = [];
        const currentStep = S.plan.planSteps?.[S.step] || 'البدء بخطوة صغيرة يومية لمدة 5–10 دقائق.';
        const assessmentLevel = S.assessment?.result?.level;

        recos.push(`ركّز هذا الأسبوع على: ${currentStep}`);
        recos.push('ادعم التنفيذ: خصّص 10 دقائق يوميًا، مع جملة تشجيع محدّدة مثل "لاحظت محاولتك، ممتاز!" دون مبالغة.');
        
        if (assessmentLevel === 'احتياج مرتفع') {
            recos.push('خفّض صعوبة النشاط 20% وقدم نموذجًا عمليًا قبل الطلب. عند مقاومة متكررة، قسّم المهمة إلى نصفين.');
        } else if (assessmentLevel === 'احتياج متوسط') {
            recos.push('ثبّت الروتين أولًا (وقت/مكان ثابتان) ثم زد التحدي تدريجيًا كل 3 أيام.');
        } else if (assessmentLevel === 'احتياج منخفض') {
            recos.push('امنح مساحة للاستقلال: اسأل "كيف تحب أن تبدأ؟" ودع الطفل يقترح تعديلًا صغيرًا.');
        } else {
            recos.push('أتمّم التقييم الأولي داخل الحوار لتحصل على توصيات أكثر دقة.');
        }
        
        recos.push('تصعيد آمن: إذا ظهر تجنّب شديد مستمر لأكثر من أسبوعين أو بكاء/ألم بطني يومي قبل المدرسة، يُفضّل استشارة مختص مرخّص.');
        return recos;
      }
    };

    // =================================================================
    //  Module: Event Handlers & Logic - وحدة معالجة الأحداث والمنطق
    // =================================================================
    App.handlers = {
      _app: App,

      handleNavigation(event) {
        const button = event.target.closest('[data-action="navigate"]');
        if (button) {
          const screenId = button.dataset.screen;
          this._app.ui.showScreen(screenId);
        }
      },
      
      handleModalToggle(event) {
        const button = event.target.closest('[data-action]');
        if (!button) return;
        const action = button.dataset.action;
        const modalId = button.dataset.modal;

        if (action === 'open-modal') {
          if (modalId === 'pin-modal') this._app.pin.setupPinModalForReset();
          if (modalId === 'parent-modal') this._app.pin.setupParentModal();
          this._app.ui.showModal(modalId);
        } else if (action === 'close-modal') {
          this._app.ui.hideModal(modalId);
        }
      },

      validateProfileForm() {
        const name = this._app.dom['child-name-input'].value.trim().length > 1;
        const { age, gender } = this._app.state;
        this._app.ui.toggleButtonState(this._app.dom['continue-profile-btn'], name && age && gender);
      },
      
      submitProfile() {
        if (this._app.dom['continue-profile-btn'].disabled) return;
        this._app.state.name = App.utils.stripPII(this._app.dom['child-name-input'].value.trim()).slice(0, 32);
        this._app.state.aiName = App.utils.getAiName(this._app.state.age, this._app.state.gender);
        this._app.saveState();
        this._app.ui.showScreen('parent-input-screen');
      },

      validateParentForm() {
        const p = this._app.dom['child-personality'].value.trim().length > 5;
        const c = this._app.dom['child-challenges'].value.trim().length > 10;
        this._app.ui.toggleButtonState(this._app.dom['analyze-btn'], p && c);
      },
      
      submitPlanApproval() {
        this._app.state.step = 0;
        this._app.state.chat = [];
        this._app.state.askedQuestions = [];
        this._app.state.lastDateKey = null;
        this._app.saveState();
        this._app.ui.updateHomeScreen();
        this._app.ui.showScreen('home-screen');
      },

      initiateChat() {
        this._app.ui.showScreen('chat-screen');
        this._app.dom['chat-messages'].innerHTML = '';
        this._app.dom['chat-options-container'].innerHTML = '';
        this._app.state.lastDateKey = null;

        if (this._app.state.chat.length > 0) {
            this._app.state.chat.forEach(msg => {
                this._app.ui.addChatMessage(msg.parts[0].text, msg.role, msg.ts);
            });
            const lastMsg = this._app.state.chat[this._app.state.chat.length - 1];
            if (lastMsg.role === 'model') {
                const options = this._app.ai._extractOptions(lastMsg.parts[0].text, lastMsg.parts[0].text);
                this._app.ui.renderChatOptions(options);
            }
        } else {
            this._app.ai.getChatResponse(true); // First message
        }
      },
      
      handleUserMessage(text) {
        if (!text || text.trim().length === 0) return;
        
        const cleanText = App.utils.stripPII(text.trim()).slice(0, 300);
        this.pushMessageToChat(cleanText, 'user');
        
        if (this._app.dom['chat-input']) this._app.dom['chat-input'].value = '';
        this._app.ui.renderChatOptions([]); // Clear options after selection

        this._app.ai.getChatResponse();
      },
      
      pushMessageToChat(text, role, ts = Date.now()) {
        this._app.ui.addChatMessage(text, role, ts);
        this._app.state.chat.push({ role, parts: [{ text }], ts });
        this._app.saveState();

        // Mark last user message as 'seen'
        if (role === 'model') {
            const ticks = this._app.dom['chat-messages'].querySelectorAll('.tick.dim');
            const lastTick = ticks[ticks.length - 1];
            if (lastTick) {
                lastTick.textContent = '✓✓';
                lastTick.classList.remove('dim');
            }
        }
      },
      
      toggleLanguage() {
        this._app.state.language = this._app.state.language === 'ar' ? 'en' : 'ar';
        this._app.saveState();
        this._app.ui.updateHomeScreen();
        this.pushMessageToChat(`(System instruction: switch language to ${this._app.state.language}.)`, 'user');
        this._app.ai.getChatResponse();
      }
    };
    
    // =================================================================
    //  Module: PIN Security - وحدة أمان رمز الحماية
    // =================================================================
    App.pin = {
        _app: App,
        
        _getState() {
            try { return JSON.parse(localStorage.getItem('sadiki-pin-state')) || { fails: 0, lockedUntil: 0 }; } 
            catch { return { fails: 0, lockedUntil: 0 }; }
        },
        _setState(state) {
            localStorage.setItem('sadiki-pin-state', JSON.stringify(state));
        },
        _isLocked() {
            return this._getState().lockedUntil > Date.now();
        },
        _showLockMessage(element) {
            const state = this._getState();
            if (!this._isLocked()) {
                element.classList.add('hidden');
                return;
            }
            const minsLeft = Math.ceil((state.lockedUntil - Date.now()) / 60000);
            element.textContent = `محاولات كثيرة. حاول بعد ${minsLeft} دقيقة.`;
            element.classList.remove('hidden');
        },

        setupPinModalForReset() {
            this._app.dom['pin-input'].value = '';
            this._app.dom['pin-error'].classList.add('hidden');
            this._showLockMessage(this._app.dom['pin-lock-msg']);
            
            // This handler is specific to resetting the app
            this._app.dom['pin-ok'].onclick = () => {
                if (this._isLocked()) return;
                
                if (this._app.dom['pin-input'].value === this._app.config.PIN_CODE) {
                    this._app.resetState();
                    localStorage.removeItem('sadiki-pin-state');
                    location.reload();
                } else {
                    this._handleFailedAttempt(this._app.dom['pin-error'], this._app.dom['pin-lock-msg']);
                }
            };
        },
        
        setupParentModal() {
            this._app.dom['parent-pin'].value = '';
            this._app.dom['parent-auth-error'].classList.add('hidden');
            this._showLockMessage(this._app.dom['parent-lock-msg']);
            this._app.dom['parent-auth'].classList.remove('hidden');
            this._app.dom['parent-dashboard'].classList.add('hidden');
        },

        handleParentUnlock() {
            if (this._isLocked()) {
                this._showLockMessage(this._app.dom['parent-lock-msg']);
                return;
            }

            if (this._app.dom['parent-pin'].value === this._app.config.PIN_CODE) {
                this._setState({ fails: 0, lockedUntil: 0 }); // Reset on success
                this._app.dom['parent-auth'].classList.add('hidden');
                this._app.dom['parent-dashboard'].classList.remove('hidden');
                this._app.ui.fillParentDashboard();
            } else {
                this._handleFailedAttempt(this._app.dom['parent-auth-error'], this._app.dom['parent-lock-msg']);
            }
        },

        _handleFailedAttempt(errorEl, lockEl) {
            const state = this._getState();
            state.fails++;
            if (state.fails >= this._app.config.MAX_PIN_ATTEMPTS) {
                state.lockedUntil = Date.now() + this._app.config.LOCKOUT_DURATION_MS;
                this._showLockMessage(lockEl);
            }
            this._setState(state);
            errorEl.classList.remove('hidden');
        }
    };

    // =================================================================
    //  Module: Utility Functions - وظائف مساعدة
    // =================================================================
    App.utils = {
      getAiName: (age, gender) => {
        if (age === '3-7') return gender === 'ذكر' ? 'سيف' : 'نورة';
        if (age === '8-12') return gender === 'ذكر' ? 'راشد' : 'مريم';
        if (age === '13-18') return gender === 'ذكر' ? 'سultan' : 'آمنة';
        return 'صديقي الذكي';
      },
      formatTime: (ts) => new Date(ts || Date.now()).toLocaleTimeString('ar-AE', { hour: '2-digit', minute: '2-digit' }),
      getDateLabel: (ts) => {
        const d = new Date(ts), today = new Date(), yest = new Date();
        yest.setDate(today.getDate() - 1);
        const key = d.toISOString().slice(0, 10);
        if (key === today.toISOString().slice(0, 10)) return { key, label: 'اليوم' };
        if (key === yest.toISOString().slice(0, 10)) return { key, label: 'أمس' };
        return { key, label: d.toLocaleDateString('ar-AE') };
      },
      stripPII: (text) => {
        const piiRegex = /([^\w]|^)(\+?\d{7,}|\d{3}[-\s]?\d{3}[-\s]?\d{4}|[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,})/ig;
        return text ? text.replace(piiRegex, ' [معلومة خاصة محجوبة] ') : '';
      }
    };
    
    // =================================================================
    //  Event Listeners Binding - ربط مستمعي الأحداث
    // =================================================================
    App.bindEventListeners = function() {
      // General navigation and modal toggles
      this.dom.main.addEventListener('click', (e) => {
        App.handlers.handleNavigation(e);
      });
      document.body.addEventListener('click', (e) => {
        App.handlers.handleModalToggle(e);
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            App.ui.hideModal('pin-modal');
            App.ui.hideModal('parent-modal');
        }
      });
      // Close modals on backdrop click
      this.dom['pin-modal'].addEventListener('click', e => e.target === this.dom['pin-modal'] && App.ui.hideModal('pin-modal'));
      this.dom['parent-modal'].addEventListener('click', e => e.target === this.dom['parent-modal'] && App.ui.hideModal('parent-modal'));


      // --- Profile Setup ---
      this.dom.ageBtns.forEach(btn => btn.addEventListener('click', e => {
        this.state.age = e.currentTarget.dataset.age;
        this.dom.ageBtns.forEach(b => b.classList.remove('selected'));
        e.currentTarget.classList.add('selected');
        App.handlers.validateProfileForm();
      }));
      this.dom.genderBtns.forEach(btn => btn.addEventListener('click', e => {
        this.state.gender = e.currentTarget.dataset.gender;
        this.dom.genderBtns.forEach(b => b.classList.remove('selected'));
        e.currentTarget.classList.add('selected');
        App.handlers.validateProfileForm();
      }));
      this.dom['child-name-input'].addEventListener('input', () => App.handlers.validateProfileForm());
      this.dom['continue-profile-btn'].addEventListener('click', () => App.handlers.submitProfile());
      
      // --- Parent Input ---
      this.dom['child-personality'].addEventListener('input', () => App.handlers.validateParentForm());
      this.dom['child-challenges'].addEventListener('input', () => App.handlers.validateParentForm());
      this.dom['analyze-btn'].addEventListener('click', () => App.ai.generatePlan(false));
      
      // --- Plan Review & Modification ---
      this.dom['approve-plan-btn'].addEventListener('click', () => App.handlers.submitPlanApproval());
      this.dom['re-analyze-btn'].addEventListener('click', () => App.ai.generatePlan(true));
      
      // --- Home Screen ---
      this.dom['initiate-chat-btn'].addEventListener('click', () => App.handlers.initiateChat());
      
      // --- Chat ---
      this.dom['chat-form'].addEventListener('submit', (e) => {
        e.preventDefault();
        App.handlers.handleUserMessage(this.dom['chat-input'].value);
      });
      this.dom['language-toggle-btn'].addEventListener('click', () => App.handlers.toggleLanguage());

      // --- Modals ---
      this.dom['parent-unlock'].addEventListener('click', () => App.pin.handleParentUnlock());
      this.dom['pd-refresh'].addEventListener('click', () => App.ui.renderParentRecommendations());
    };

    // --- Start the application ---
    App.init();
    
  });
  </script>
</body>
</html>


