<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>صديقي الذكي — مشروع مدرسي (مدرسة الإمارات الوطنية)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    html,body{height:100%;margin:0;padding:0;overscroll-behavior-y:contain}
    body{font-family:'Tajawal',sans-serif;-webkit-tap-highlight-color:transparent}
    #app-wrapper{
      background-image:
        linear-gradient( rgba(245,248,252,.90), rgba(245,248,252,.94) ),
        url('https://images.unsplash.com/photo-1607093800959-5b6b6f72b316?q=80&w=2000&auto=format&fit=crop');
      background-size:cover;background-position:center
    }
    #app-container{height:100%;height:100dvh}
    .screen,.modal{display:none}.screen.active,.modal.active{display:flex}
    .bg-screen{background:rgba(248,250,252,.96);backdrop-filter:blur(3px)}
    .chat-bubble{animation:pop .25s cubic-bezier(.2,.9,.3,1.4)}
    @keyframes pop{from{opacity:0;transform:scale(.6)}to{opacity:1;transform:scale(1)}}
    #chat-messages::-webkit-scrollbar{width:6px}
    #chat-messages::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:10px}
    .age-btn.selected,.gender-btn.selected{border-color:#0ea5e9;background:#f0f9ff;color:#0284c7}
    #continue-profile-btn:disabled,#analyze-btn:disabled{background:#94a3b8;cursor:not-allowed}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .6rem;border-radius:9999px;font-size:.75rem}
    .brand-gradient{background:linear-gradient(135deg,#0ea5e9 0%,#14b8a6 100%);-webkit-background-clip:text;background-clip:text;color:transparent}
  </style>
</head>
<body class="bg-slate-200 text-slate-800 antialiased">
  <div id="app-wrapper">
    <div id="app-container" class="w-full max-w-md md:max-w-lg mx-auto bg-transparent shadow-lg flex flex-col overflow-hidden relative">
      <main id="main" class="flex-grow relative flex flex-col"></main>
      <footer class="w-full shrink-0 bg-white/75 backdrop-blur border-t border-slate-200">
        <div class="px-3 py-2 text-[11px] sm:text-xs flex flex-col sm:flex-row items-center justify-between gap-2">
          <div class="flex items-center gap-2">
            <span class="badge bg-cyan-100 text-cyan-700 font-semibold"><i data-lucide="shield-check" class="w-3.5 h-3.5"></i> أمان الطفل أولاً</span>
            <span class="badge bg-emerald-100 text-emerald-700 font-semibold"><i data-lucide="sprout" class="w-3.5 h-3.5"></i> توجيه تربوي إيجابي</span>
          </div>
          <div class="text-center leading-tight">
            <div class="font-bold brand-gradient">© صديقي الذكي — مشروع مدرسي</div>
            <div class="text-slate-500">مدرسة الإمارات الوطنية — حقوق الطالب: <span class="font-bold">يوسف سالمين</span></div>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const main = document.getElementById('main');

    main.innerHTML = `
      <section id="start-screen" class="screen active bg-screen flex-col items-center justify-center p-8 text-center">
        <div class="w-24 h-24 rounded-full bg-white/70 flex items-center justify-center mb-4"><i data-lucide="bot" class="w-12 h-12 text-sky-600"></i></div>
        <h1 class="text-3xl font-bold mb-2">صديقي الذكي</h1>
        <p class="text-slate-600 mb-8">مرشد رقمي يساعد طفلك على تخطي التحديات الاجتماعية بخطوات قصيرة وآمنة.</p>
        <button id="start-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-8 rounded-full shadow-lg">ابدأ</button>
      </section>

      <section id="intro-screen" class="screen bg-screen flex-col items-stretch p-8 overflow-y-auto">
        <i data-lucide="shield-check" class="w-16 h-16 text-sky-500 mx-auto mb-4"></i>
        <h2 class="text-2xl font-bold text-center mb-2">كيف نعمل؟ والتزاماتنا</h2>
        <p class="text-slate-600 text-center mb-6">نربط وصف وليّ الأمر بتحليل ذكي، نولّد خطة أولية للمراجعة، ثم اختبار قصير للطفل لتحديد الاحتياج الحقيقي، وبعدها تدريب متدرّج.</p>
        <ul class="space-y-3 text-sm text-slate-700">
          <li class="flex items-start gap-3"><i data-lucide="scale" class="w-5 h-5 text-sky-500 mt-0.5"></i><span><b>امتثال:</b> الالتزام بقوانين الإمارات والمعايير الدولية لسلامة الطفل.</span></li>
          <li class="flex items-start gap-3"><i data-lucide="database" class="w-5 h-5 text-sky-500 mt-0.5"></i><span><b>خصوصية:</b> لا نطلب بيانات تعريفية؛ التخزين محلي؛ لا تُشارك المحادثات.</span></li>
          <li class="flex items-start gap-3"><i data-lucide="stethoscope" class="w-5 h-5 text-sky-500 mt-0.5"></i><span><b>حدود:</b> إرشاد تربوي—not تشخيص طبي/نفسي. عند مؤشرات الخطر نوصي بالتصعيد لمختص مرخّص.</span></li>
          <li class="flex items-start gap-3"><i data-lucide="child" class="w-5 h-5 text-sky-500 mt-0.5"></i><span><b>الهدف:</b> تمكين الطفل تدريجياً للخروج من المشكلة عبر تمارين قابلة للقياس.</span></li>
        </ul>
        <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <button id="intro-back" class="bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-full hover:bg-slate-300">رجوع</button>
          <button id="intro-accept" class="bg-sky-600 text-white font-bold py-3 px-6 rounded-full hover:bg-sky-700">موافق</button>
        </div>
      </section>

      <section id="profile-setup-screen" class="screen bg-screen flex-col p-8 overflow-y-auto">
        <i data-lucide="user-round-check" class="w-16 h-16 text-sky-500 mx-auto mb-6"></i>
        <h2 class="text-2xl font-bold text-center mb-2">ملف البطل الشخصي</h2>
        <div class="w-full space-y-6">
          <div><label class="font-bold mb-2 block">اسم الطفل/الطفلة</label><input id="child-name-input" type="text" class="w-full bg-white/90 border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-sky-400" placeholder="مثال: خالد أو علياء"></div>
          <div>
            <p class="font-bold mb-2">الفئة العمرية</p>
            <div class="grid grid-cols-3 gap-3">
              <button data-age="3-7"  class="age-btn bg-white/90 border-2 border-slate-200 p-3 rounded-xl font-bold">3–7</button>
              <button data-age="8-12" class="age-btn bg-white/90 border-2 border-slate-200 p-3 rounded-xl font-bold">8–12</button>
              <button data-age="13-18" class="age-btn bg-white/90 border-2 border-slate-200 p-3 rounded-xl font-bold">13–18</button>
            </div>
          </div>
          <div>
            <p class="font-bold mb-2">الجنس</p>
            <div class="grid grid-cols-2 gap-3">
              <button data-gender="ذكر"  class="gender-btn bg-white/90 border-2 border-slate-200 p-3 rounded-xl font-bold">ذكر</button>
              <button data-gender="أنثى" class="gender-btn bg-white/90 border-2 border-slate-200 p-3 rounded-xl font-bold">أنثى</button>
            </div>
          </div>
        </div>
        <div class="mt-8">
          <button id="continue-profile-btn" class="w-full bg-sky-600 text-white font-bold py-3 px-6 rounded-full text-lg shadow-lg" disabled>متابعة</button>
        </div>
      </section>

      <section id="parent-input-screen" class="screen bg-screen flex-col p-8 overflow-y-auto">
        <i data-lucide="file-text" class="w-16 h-16 text-sky-500 mx-auto mb-6"></i>
        <h2 class="text-2xl font-bold text-center mb-2">رؤية وليّ الأمر</h2>
        <p class="text-slate-600 text-center mb-6">كلما كانت التفاصيل أدق، كانت الخطة أفضل. لا نطلب بيانات تعريفية.</p>
        <div class="space-y-6">
          <div><label class="font-bold mb-2 block">1) شخصية الطفل</label><textarea id="child-personality" rows="3" class="w-full bg-white/90 border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-sky-400" placeholder="مثال: مبدع، هادئ، حساس، حركي..."></textarea></div>
          <div><label class="font-bold mb-2 block">2) أهم التحديات الاجتماعية</label><textarea id="child-challenges" rows="4" class="w-full bg-white/90 border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-sky-400" placeholder="مثال: صعوبة تكوين صداقات، خجل من المشاركة..."></textarea></div>
        </div>
        <div class="mt-8">
          <button id="analyze-btn" class="w-full bg-sky-600 text-white font-bold py-3 px-6 rounded-full text-lg shadow-lg hover:bg-sky-700" disabled>تحليل وإنشاء الخطة الأولية</button>
        </div>
      </section>

      <section id="plan-review-screen" class="screen bg-screen flex-col p-8 overflow-y-auto">
        <div id="loading-spinner" class="m-auto text-center items-center justify-center">
          <i data-lucide="loader-circle" class="w-16 h-16 text-sky-500 mx-auto mb-4 animate-spin"></i>
          <h3 class="text-xl font-bold">إنشاء خطة أولية دقيقة...</h3>
          <p class="text-slate-500">يستغرق لحظات.</p>
        </div>
        <div id="plan-content" class="hidden flex-col">
          <i data-lucide="clipboard-check" class="w-16 h-16 text-green-500 mx-auto mb-6"></i>
          <h2 class="text-2xl font-bold text-center mb-2">الخطة المقترحة (للمراجعة)</h2>
          <p class="text-slate-600 text-center mb-6">اختر: <b>موافقة</b> أو <b>طلب تعديل</b>. عند التعديل نجمع الأسباب ونولّد خطة جديدة.</p>
          <div class="bg-white border border-slate-200 rounded-xl p-4 space-y-4">
            <div><h4 class="font-bold flex items-center gap-2"><i data-lucide="user-round-cog" class="w-5 h-5 text-sky-600"></i>ملخص التحليل</h4><p id="ai-analysis-summary" class="text-slate-700 mt-1"></p></div>
            <div><h4 class="font-bold flex items-center gap-2"><i data-lucide="target" class="w-5 h-5 text-sky-600"></i>فرضية الاحتياجات</h4><ul id="ai-needs-hypo" class="list-disc list-inside mt-2 space-y-1 text-slate-700"></ul></div>
            <div><h4 class="font-bold flex items-center gap-2"><i data-lucide="list-checks" class="w-5 h-5 text-sky-600"></i>خطوات التدريب</h4><ul id="ai-plan-steps" class="list-decimal list-inside mt-2 space-y-1 text-slate-700"></ul></div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-6">
            <button id="approve-plan-btn" class="w-full bg-emerald-600 text-white font-bold py-3 px-6 rounded-full shadow hover:bg-emerald-700">موافقة على الخطة</button>
            <button id="request-edit-btn" class="w-full bg-amber-500 text-white font-bold py-3 px-6 rounded-full shadow hover:bg-amber-600">طلب تعديل</button>
          </div>
        </div>
      </section>

      <section id="plan-change-screen" class="screen bg-screen flex-col p-8 overflow-y-auto">
        <i data-lucide="edit" class="w-16 h-16 text-sky-500 mx-auto mb-6"></i>
        <h2 class="text-2xl font-bold text-center mb-2">أسباب التعديل</h2>
        <textarea id="plan-change-reason" rows="6" class="w-full bg-white/90 border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-sky-400" placeholder="اذكر الأسباب المحددة: صعوبة خطوة، مواقف واقعية، أهداف جديدة، حساسية ثقافية/مدرسية..."></textarea>
        <div class="mt-6">
          <button id="re-analyze-btn" class="w-full bg-sky-600 text-white font-bold py-3 px-6 rounded-full text-lg shadow hover:bg-sky-700">إعادة التحليل وإنتاج خطة جديدة</button>
        </div>
      </section>

      <section id="home-screen" class="screen bg-transparent flex-col p-6">
        <header class="flex justify-between items-center mb-6">
          <div><p id="home-greeting" class="text-slate-500"></p><h2 id="home-mission-status" class="text-2xl font-bold">جاهز لمغامرة اليوم؟</h2></div>
          <button id="reset-app-btn" class="p-2 rounded-full bg-white/60 hover:bg-red-100 text-red-500" title="إعادة الضبط"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
        </header>
        <main class="flex-grow flex flex-col justify-center items-center text-center">
          <div class="w-44 h-44 md:w-48 md:h-48 bg-white/60 backdrop-blur-sm rounded-full flex items-center justify-center mb-6"><i data-lucide="bot" class="w-24 h-24 md:w-28 md:h-28 text-sky-600"></i></div>
          <h3 id="home-ai-name-intro" class="text-2xl font-bold mb-2"></h3>
          <p id="home-intro-text" class="text-slate-500 max-w-xs mb-6"></p>
          <button id="initiate-chat-btn" class="w-full bg-sky-600 text-white font-bold py-4 px-6 rounded-full text-lg shadow flex items-center justify-center gap-2"><i data-lucide="message-circle"></i><span id="start-chat-btn-text"></span></button>
        </main>
      </section>

      <section id="chat-screen" class="screen bg-screen flex-col">
        <header class="bg-white p-4 flex items-center gap-4 border-b border-slate-200">
          <button id="end-chat-btn" class="p-2 rounded-full hover:bg-slate-100"><i data-lucide="arrow-right"></i></button>
          <div class="w-10 h-10 bg-gradient-to-br from-cyan-100 to-sky-200 rounded-full flex items-center justify-center"><i data-lucide="bot" class="w-6 h-6 text-sky-600"></i></div>
          <div class="flex-grow"><h3 id="chat-header-name" class="font-bold"></h3><p class="text-xs text-green-500 font-medium flex items-center gap-1"><span class="w-2 h-2 bg-green-400 rounded-full"></span>متصل</p></div>
          <button id="language-toggle-btn" class="p-2 rounded-full hover:bg-slate-100 text-slate-600" title="تبديل اللغة"><i data-lucide="languages" class="w-5 h-5"></i></button>
        </header>
        <main id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto"></main>
        <footer class="p-4 border-t border-slate-200 bg-white/85 backdrop-blur-sm">
          <div id="chat-options-container" class="mb-3 grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
          <form id="chat-form" class="flex items-center gap-2">
            <input id="chat-input" type="text" placeholder="اكتب ردك هنا..." class="w-full bg-white border-2 border-slate-200 rounded-full py-2 px-4 focus:outline-none focus:border-sky-400"/>
            <button type="submit" class="bg-sky-600 text-white rounded-full p-3 hover:bg-sky-700"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
          </form>
        </footer>
      </section>
    `;

    const $ = (id) => document.getElementById(id);
    const show = (id) => document.querySelectorAll('.screen').forEach(s => s.classList.toggle('active', s.id === id));

    const STORAGE = 'sadiki-ai-v23';
    let state = {};
    const save = ()=>{ try{ localStorage.setItem(STORAGE, JSON.stringify(state)); }catch{} };
    const load = ()=>{ try{ const d=localStorage.getItem(STORAGE); if(d){ state=JSON.parse(d); return true; } }catch{} return false; };
    const resetState = ()=> state = { language:'ar', age:null, gender:null, name:null, aiName:null, parentDesc:null, plan:null, chat:[], step:0, assessment:null };

    const UAE_COMPLIANCE = `
- التزم بقوانين الإمارات والمعايير الدولية لسلامة الطفل.
- لا تقدم تشخيصاً طبياً/نفسيّاً؛ عند مؤشرات الخطر وجّه لوليّ الأمر/المدرسة ومختص مرخّص.
- لا تطلب بيانات تعريفية (عنوان/مدرسة/أرقام).
- أي إساءة/تنمّر/إيذاء: أوقف التقدّم وقدّم رسالة تصعيد.
`;

    const getAiName = (age,gender)=>{
      if(age==='3-7') return gender==='ذكر'?'سيف':'نورة';
      if(age==='8-12') return gender==='ذكر'?'راشد':'مريم';
      if(age==='13-18') return gender==='ذكر'?'سلطان':'آمنة';
      return 'صديقي الذكي';
    };

    const dom = {
      startBtn: $('start-btn'), introBack: $('intro-back'), introAccept: $('intro-accept'),
      ageBtns: [...document.querySelectorAll('.age-btn')], genderBtns: [...document.querySelectorAll('.gender-btn')],
      nameInput: $('child-name-input'), continueProfile: $('continue-profile-btn'),
      personality: $('child-personality'), challenges: $('child-challenges'), analyzeBtn: $('analyze-btn'),
      loading: $('loading-spinner'), planContent: $('plan-content'),
      planSummary: $('ai-analysis-summary'), needsList: $('ai-needs-hypo'), stepsList: $('ai-plan-steps'),
      approve: $('approve-plan-btn'), requestEdit: $('request-edit-btn'),
      reason: $('plan-change-reason'), reAnalyze: $('re-analyze-btn'),
      greeting: $('home-greeting'), aiIntro: $('home-ai-name-intro'), introText: $('home-intro-text'),
      mission: $('home-mission-status'), startChat: $('initiate-chat-btn'),
      chatMessages: $('chat-messages'), chatOptions: $('chat-options-container'),
      chatForm: $('chat-form'), chatInput: $('chat-input'),
      endChat: $('end-chat-btn'), languageToggle: $('language-toggle-btn'),
      resetApp: $('reset-app-btn')
    };

    dom.startBtn.addEventListener('click', ()=> show('intro-screen'));
    dom.introBack.addEventListener('click', ()=> show('start-screen'));
    dom.introAccept.addEventListener('click', ()=> show('profile-setup-screen'));

    dom.ageBtns.forEach(b=>b.addEventListener('click',e=>{
      state.age=e.currentTarget.dataset.age; dom.ageBtns.forEach(x=>x.classList.remove('selected')); e.currentTarget.classList.add('selected'); validateProfile();
    }));
    dom.genderBtns.forEach(b=>b.addEventListener('click',e=>{
      state.gender=e.currentTarget.dataset.gender; dom.genderBtns.forEach(x=>x.classList.remove('selected')); e.currentTarget.classList.add('selected'); validateProfile();
    }));
    dom.nameInput.addEventListener('input', validateProfile);
    dom.continueProfile.addEventListener('click', ()=>{
      if(dom.continueProfile.disabled) return;
      state.name = dom.nameInput.value.trim();
      state.aiName = getAiName(state.age, state.gender);
      show('parent-input-screen');
    });
    function validateProfile(){
      dom.continueProfile.disabled = !(dom.nameInput.value.trim().length>1 && state.age && state.gender);
    }

    dom.personality.addEventListener('input', validateParent);
    dom.challenges.addEventListener('input', validateParent);
    function validateParent(){ dom.analyzeBtn.disabled = !(dom.personality.value.trim().length>5 && dom.challenges.value.trim().length>10); }

    dom.analyzeBtn.addEventListener('click', ()=> generatePlan(false));
    dom.reAnalyze.addEventListener('click', ()=> generatePlan(true));

    // ---------- بروكسي ----------
    async function callAIProxy({ systemInstruction, messages, history, mode='chat', forceLang='ar' }) {
      // إذا وصلت messages نُرسلها كما هي؛ وإلا نبنيها من history
      let outgoing = [];
      if (Array.isArray(messages) && messages.length) {
        outgoing = messages;
      } else if (Array.isArray(history)) {
        outgoing = history.map(m => ({ role: m.role === 'user' ? 'user' : 'model', content: (m.parts?.[0]?.text || '') }));
      }

      const body = {
        system: systemInstruction || '',
        messages: outgoing,
        model: "auto",
        mode,
        force_lang: forceLang,
        guard_level: "strict",
        long: true,
        max_chunks: 4,
        stream: false,
        timeout_ms: 28000
      };

      const resp = await fetch('/.netlify/functions/gemini-proxy', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
      });
      if (!resp.ok) {
        let err;
        try { err = await resp.json(); } catch { err = { error: resp.statusText, status: resp.status }; }
        throw err;
      }
      return resp.json();
    }

    const planPrompt = (desc)=>`
${UAE_COMPLIANCE}
أنت خبير تربية طفل وسلامة رقمية. حلّل وصف وليّ الأمر:
"${desc}"
أرجع JSON بالعربية فقط:
{
 "analysisSummary":"جملة مختصرة ودقيقة",
 "needsHypothesis":["3 نقاط فرضية دقيقة"],
 "planSteps":["3 خطوات تدريبية متدرجة وقابلة للقياس"],
 "initialAssessment":{
   "intro":"رسالة مطمئنة قبل الاختبار",
   "items":[
     {"type":"choice","q":"سؤال شعوري مرتبط بالمشكلة","options":["تمام","شوية","صعب"],"map":{"تمام":0,"شوية":1,"صعب":2}},
     {"type":"roleplay","q":"موقف قصير لتجربة السلوك","success_hint":"تلميح تشجيعي"},
     {"type":"selfCheck","q":"ثقتك الآن (0-10)","scaleMin":0,"scaleMax":10}
   ],
   "scoring":"منهجية تحديد (مرتفع/متوسط/منخفض)",
   "safeguards":"متى نوقف الحوار ونصعّد"
 }
}
لا تستخدم قوالب؛ ابنِ على وصف وليّ الأمر فقط.
`;

    const chatRules = ()=>{
      const lang = state.language==='ar'?'Emirati Arabic':'English';
      const persona = (()=>{
        if(state.gender==='ذكر'){ if(state.age==='3-7') return {p:'Saif',s:'game'}; if(state.age==='8-12') return {p:'Rashid',s:'role-playing'}; return {p:'Sultan',s:'simulation & discussion'} }
        else { if(state.age==='3-7') return {p:'Noora',s:'game'}; if(state.age==='8-12') return {p:'Mariam',s:'role-playing'}; return {p:'Amna',s:'simulation & discussion'} }
      })();
      return `
${UAE_COMPLIANCE}
ROLE: أنت ${persona.p} مرشد داعم.
CHILD: "${state.name}" (${state.gender})، فئة ${state.age}.
PLAN: ${JSON.stringify(state.plan||{})}
ASSESSMENT: ${JSON.stringify(state.assessment?.result||{})}
STRICT:
1) استخدم ${lang} فقط.
2) المنهجية: Intro → Practice → Mission → Follow-up. الأسلوب: ${persona.s}.
3) اربط الردود بمدخلات الوالدين والخطة والاختبار—بدون قوالب ثابتة.
4) اقترح خيارات مشاعر/ردود فعل الطفل فقط. افصل الرد عن الخيارات بسطر فارغ وتبدأ الخيارات بـ "- ".
5) عند مؤشرات خطر: أوقف التقدم وقدّم رسالة تصعيد لوليّ الأمر/المدرسة.
`;
    };

    async function generatePlan(isModification){
      let desc='';
      if(isModification){
        const reason = dom.reason.value.trim(); if(reason.length<10){ dom.reason.focus(); return; }
        desc = (state.parentDesc||'') + ` | أسباب التعديل: ${reason}`;
      }else{
        desc = `الشخصية: ${dom.personality.value.trim()} | التحديات: ${dom.challenges.value.trim()}`;
        state.parentDesc = desc;
      }

      show('plan-review-screen'); dom.loading.style.display='flex'; dom.planContent.classList.add('hidden');

      let attempt=0, maxAttempts=2, lastErr=null;
      while(attempt<maxAttempts){
        try{
          // **** نرسل رسالة مستخدم صريحة حتى لا يكون contents فارغًا ****
          const userMsg = { role: "user", content: planPrompt(desc) };
          const { text } = await callAIProxy({
            systemInstruction: planPrompt(desc),
            messages: [userMsg],
            mode:'plan',
            forceLang:'ar'
          });
          const plan = JSON.parse( (text||'').replace(/```json|```/g,'').trim() );
          state.plan = plan;
          state.assessment = { spec: plan.initialAssessment, result:null, answers:[] };
          renderPlan(plan);
          dom.loading.style.display='none'; dom.planContent.classList.remove('hidden'); save();
          return;
        }catch(e){ lastErr = e; attempt++; }
      }

      dom.loading.style.display='none';
      $('plan-review-screen').innerHTML = `
        <div class="flex flex-col items-center justify-center text-center gap-3 py-12">
          <i data-lucide="wifi-off" class="w-16 h-16 text-amber-500"></i>
          <h3 class="text-xl font-bold">تعذّر إنشاء الخطة الآن</h3>
          <p class="text-slate-600 text-sm max-w-md">السبب (من المزود): <span id="err-reason">—</span></p>
          <details class="text-left bg-slate-50 border rounded-lg p-3 w-full max-w-lg">
            <summary class="cursor-pointer font-bold">تفاصيل التشخيص</summary>
            <pre id="err-details" class="text-[11px] whitespace-pre-wrap break-words mt-2"></pre>
          </details>
          <div class="flex gap-3 mt-3">
            <button id="retry-plan" class="bg-sky-600 text-white font-bold py-3 px-6 rounded-full hover:bg-sky-700">إعادة المحاولة</button>
            <button id="back-to-parent" class="bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-full hover:bg-slate-300">رجوع</button>
          </div>
        </div>`;
      lucide.createIcons();
      $('retry-plan').addEventListener('click', ()=>generatePlan(isModification));
      $('back-to-parent').addEventListener('click', ()=>show('parent-input-screen'));

      try {
        const upstream = (lastErr && (lastErr.upstream || lastErr)) || {};
        $('err-reason').textContent = upstream.message || upstream.error || 'غير معروف';
        $('err-details').textContent = JSON.stringify(upstream, null, 2);
      } catch {}
    }

    function renderPlan(plan){
      dom.planSummary.textContent = plan.analysisSummary||'';
      dom.needsList.innerHTML=''; (plan.needsHypothesis||[]).forEach(n=>{ const li=document.createElement('li'); li.textContent=n; dom.needsList.appendChild(li); });
      dom.stepsList.innerHTML=''; (plan.planSteps||[]).forEach(s=>{ const li=document.createElement('li'); li.textContent=s; dom.stepsList.appendChild(li); });
      dom.planContent.classList.remove('hidden');
    }

    dom.requestEdit.addEventListener('click', ()=> show('plan-change-screen'));
    dom.approve.addEventListener('click', ()=>{
      state.step=0; state.chat=[];
      save(); updateHome(); show('home-screen');
      beginAIOnboarding();
    });

    function beginAIOnboarding(){
      show('chat-screen');
      dom.chatMessages.innerHTML=''; dom.chatOptions.innerHTML='';
      const kick = state.language==='ar'
        ? `ابدأ الاختبار الأولي خطوة بخطوة من initialAssessment الموجودة في الخطة. قدّم المقدمة ثم السؤال الأول فقط. بعد إجابة الطفل انتقل للسؤال التالي تلقائياً.`
        : `Begin the initial assessment step-by-step from the plan's initialAssessment. Provide intro then first item only; proceed item by item after the child's reply.`;
      handleUser(kick);
    }

    function scoreAssessment(){
      const items = state.assessment?.spec?.items||[]; let score=0;
      items.forEach((it,i)=>{
        const a=state.assessment.answers[i];
        if(it.type==='choice' && it.map && a in it.map) score += it.map[a];
        if(it.type==='selfCheck' && typeof a==='number') score += a>=7?2:(a>=4?1:0);
      });
      const level = score>=3 ? 'احتياج مرتفع' : (score>=1 ? 'احتياج متوسط' : 'احتياج منخفض');
      state.assessment.result = { score, level, at: Date.now() }; save();
    }

    function addMsg(text, role='model'){
      const el=document.createElement('div');
      el.className=`chat-bubble max-w-[80%] rounded-2xl p-3 ${role==='user'?'bg-sky-600 text-white self-end':'bg-slate-200 text-slate-800 self-start'}`;
      el.innerText=text; dom.chatMessages.appendChild(el);
      setTimeout(()=>dom.chatMessages.scrollTop=dom.chatMessages.scrollHeight,30);
    }
    function showOptions(text){
      dom.chatOptions.innerHTML=''; if(!text) return;
      text.split('\n').map(t=>t.trim()).filter(Boolean).forEach(line=>{
        const clean=line.replace(/^- /,'');
        const b=document.createElement('button');
        b.className='w-full text-sky-700 bg-sky-100 font-medium py-2 px-3 rounded-lg hover:bg-sky-200 text-sm';
        b.innerText=clean; b.addEventListener('click',()=>handleUser(clean));
        dom.chatOptions.appendChild(b);
      });
    }
    function pushModel(text){ addMsg(text,'model'); state.chat.push({role:'model',parts:[{text}]}); save(); }

    function showTyping(){
      const el=`<div id="typing" class="chat-bubble self-start bg-slate-200 p-3 rounded-2xl"><span class="inline-block w-2 h-2 bg-slate-500 rounded-full animate-pulse"></span></div>`;
      dom.chatMessages.insertAdjacentHTML('beforeend',el); dom.chatMessages.scrollTop=dom.chatMessages.scrollHeight;
    }
    function hideTyping(){ document.getElementById('typing')?.remove(); }

    async function respond(){
      showTyping();
      try{
        const outgoing = state.chat.map(m => ({ role:m.role==='user'?'user':'model', content: m.parts?.[0]?.text || '' }));
        const { text } = await callAIProxy({
          systemInstruction: chatRules(),
          messages: outgoing,               // نمرّر الرسائل صراحة
          mode:'default',
          forceLang: (state.language==='ar'?'ar':'en')
        });
        hideTyping();
        const [main,...rest]=(text||'').split(/\n\n/); const opts=rest.join('\n\n');
        pushModel(main||''); showOptions(opts);
      }catch(e){
        hideTyping(); pushModel('توقف مؤقت في الاتصال. اضغط أي خيار أو اكتب للمتابعة.');
      }
    }

    function handleUser(text){
      addMsg(text,'user'); state.chat.push({role:'user',parts:[{text}]}); save();
      const spec = state.assessment?.spec;
      if(spec && !state.assessment.result){
        const last = text.trim();
        const asNumber = /^\d+$/.test(last) ? Number(last) : null;
        state.assessment.answers.push(asNumber ?? last);
        if(state.assessment.answers.length >= (spec.items||[]).length) scoreAssessment();
      }
      respond();
    }

    dom.chatForm.addEventListener('submit', e=>{ e.preventDefault(); const v=dom.chatInput.value.trim(); if(v){ handleUser(v); dom.chatInput.value=''; } });
    dom.endChat.addEventListener('click', ()=>{ show('home-screen'); updateHome(); });

    function updateHome(){
      const t={ ar:{g:`مرحباً يا ${state.name}`,m:`هدفنا:`,ready:`جاهز لمغامرة اليوم؟`,ai:`أنا ${state.aiName}`,desc:{'ذكر':'رفيجك الرقمي اللي بيساعدك خطوة بخطوة.','أنثى':'رفيجتج الرقمية اللي بتساعدج خطوة بخطوة.'},chat:`ابدأ الدردشة مع ${state.aiName}`,ph:'اكتب ردك هنا...'},
               en:{g:`Welcome, ${state.name}`,m:`Our goal:`,ready:`Ready for today’s adventure?`,ai:`I'm ${state.aiName}`,desc:{'ذكر':'Your digital buddy to help you step by step.','أنثى':'Your digital buddy to help you step by step.'},chat:`Start chat with ${state.aiName}`,ph:'Type your reply here...'} };
      const L=t[state.language];
      $('home-greeting').textContent=L.g; $('home-ai-name-intro').textContent=L.ai; $('home-intro-text').textContent=L.desc[state.gender];
      $('start-chat-btn-text').textContent=L.chat; $('chat-input').placeholder=L.ph;
      $('home-mission-status').textContent = (state.plan?.planSteps?.[state.step]) ? `${L.m} ${state.plan.planSteps[state.step]}` : L.ready;
      $('chat-header-name').textContent = state.aiName;
    }

    $('language-toggle-btn').addEventListener('click', ()=>{
      state.language = state.language==='ar' ? 'en' : 'ar'; save(); updateHome();
      state.chat.push({role:'user',parts:[{text:`(System instruction: switch language to ${state.language}.)`}]}); respond();
    });
    dom.startChat.addEventListener('click', ()=>{
      show('chat-screen'); dom.chatMessages.innerHTML=''; dom.chatOptions.innerHTML='';
      if(state.chat.length){
        state.chat.forEach(m=>addMsg(m.parts[0].text,m.role));
        const last=state.chat[state.chat.length-1]; if(last.role==='model'){ const [_,...rest]=last.parts[0].text.split(/\n\n/); showOptions(rest.join('\n\n')); }
      } else {
        const hello = state.language==='ar'?`مرحباً يا ${state.aiName}، أنا ${state.name} وجاهز للبدء.`:`Hi ${state.aiName}, I'm ${state.name} and ready to start.`; handleUser(hello);
      }
    });

    dom.resetApp.addEventListener('click', ()=>{ localStorage.removeItem(STORAGE); location.reload(); });

    function init(){
      const ok = load();
      if(!ok){ resetState(); }
      if(ok && state.name){ updateHome(); show('home-screen'); }
      lucide.createIcons();
    }
    init();
  });
  </script>
</body>
</html>
